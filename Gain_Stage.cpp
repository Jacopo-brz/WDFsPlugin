#include "Gain_Stage.h"
#include <stdlib.h>
#include <fstream>
#include <string>
#include <vector>
#include <sstream>


using Eigen::MatrixXd;
using namespace Eigen;
using namespace std;


MyMat_G PrepareGainStage(double sampleRate)
{
    //---- S Initialization ----//


    Matrix<double, 21, 21> S;
    /*
    string fname = "ESSE.txt";
    std::cout << "file name: " << fname << std::endl;


    vector<vector<string>> content;
    vector<string> rows;
    string line, word;

    fstream file(fname, ios::in);
    if (file.is_open())
    {
        while (getline(file, line))
        {
            rows.clear();

            stringstream str(line);

            while (getline(str, word, ','))
                rows.push_back(word);
            content.push_back(rows);
        }
    }
    else
        cout << "Could not open the file\n";

    std::cout << "content size " << content.size() << std::endl;

    for (int i = 0; i < content.size(); i++)
    {
        for (int j = 0; j < content[i].size(); j++)
        {
            cout << content[i][j] << " ";
        }
        cout << "\n";
    }

    std::cout << "content size: \n\n" << content[0].size() << std::endl;

    double S_matlab[21][21];
    int dim = 21;


    for (int j = 0; j < content[0].size(); j++)
    {
        int col = int(j / dim);
        int row = j % dim;

        S_matlab[row][col] = stod(content[0][j]);

    }


    for (int i = 0; i < content.size(); i++)
    {
        for (int j = 0; j < content[i].size(); j++)
        {
            cout << S_matlab[i][j] << " ";
        }
        cout << "\n";
    }


    for (int i = 0; i < 21; i++) {
        for (int j = 0; j < 21; j++) {
            S(i, j) = S_matlab[i][j];
            //std::cout << "S_matlab: \n\n" << S_matlab[i][j] << std::endl;
        }
    }

    std::cout << "S matrix: \n\n" << S << std::endl;

    */

 //   S << 0.99999550839289275128,-0.11953448993009221923,-0.03507511382533769900,-1.15497270898452586430,-0.72548517334523621169,-1.88045788232977351129,-0.00000313613298562219,0.34581508221073903320,-0.19636494495144943273,-0.54218002716218649528,-0.52562686005442804671,-1.96142389009518414156,-0.00349650447239692247,-0.00149810942174747599,-1.96342220814224210912,-0.00000007700356614603,1.96342220814224188707,0.24804577843456523945,-1.14009578637066510964,-0.00006888552072268077,-1.07137227720970806821,-0.00000315300184498529,0.88015002108073159270,0.00000054167763478932,-1.59604239631822242274,-0.28410134497676908794,-1.88014374129501615762,-0.00000312678382437963,-0.27655919960856611972,-0.11954121841399846515,0.15701798119456789049,-0.16453474231907022629,0.00003112235176898028,-0.00002851102756968388,0.00000000199094549242,0.00000260933316236503,0.00000000000010233558,-0.00000260933316237232,-0.00000032964589723581,0.00750844592756270274,0.00003976520366030648,-0.00750550694840076797,-0.00000133860526224266,0.00031548898917621587,0.96492434449702746413,0.44106968733369650293,-0.44138382836846712376,-0.00031414103475717098,-0.00000000934916124256,0.62237428181930498639,-0.07682372653745095370,-0.69919800835675460782,-0.36109211773535782042,-1.96145501244695319443,-0.00346799344482723836,-0.00149811141269296801,-1.96342481747540409387,-0.00000007700366848161,1.96342481747540409387,0.24804610808046248516,-1.14760423229822783320,-0.00010865072438298725,-1.06386677026130738177,-0.00000003190095716468,-0.00121334723347741691,0.00000051763068066185,-0.69675455042732270527,-0.30203206641187624326,0.00121338316081894015,-0.00000000402638450250,-0.29400892909669357200,-0.12708434372490276520,0.16692458537179030720,-0.17491741089563253575,0.00002983008798732061,-0.00003031581771106901,-0.00000000037033371795,-0.00000048535937074590,-0.00000000000001903534,0.00000048535937074524,0.00000006131709340852,0.00798032047508764365,0.00004227418998420155,-0.00798086715157084008,-0.00000000570190670170,-0.00021598083734974418,-0.00000051734096419313,-0.30203207469095461057,-0.69775190517337204454,0.00021602013569390157,-0.00000003359643741832,0.29421916254509239419,0.12717522291285315861,-0.16704393963223987396,0.17504250075561963995,-0.00002981451885956768,0.00003033756173038610,0.00000000039878228911,0.00000052264406811121,0.00000000000002049761,-0.00000052264406810289,-0.00000006602739552358,-0.00798600559550198368,-0.00004230441812310859,0.00798659426698612208,-0.00000312110088782061,-0.11863663168579102747,0.00000002404695412562,0.10071215410910058785,0.01793072143510716920,-0.88135712445583513919,-0.00000312275743987713,0.01744972948812764310,0.00754312531090428184,-0.00990660417722237160,0.01038266857656231119,0.00000129226378164244,0.00000180479014138520,0.00000000236127921037,0.00000309469253311165,0.00000000000012137092,-0.00000309469253311659,-0.00000039096299064421,-0.00047187454752494070,-0.00000250898632389509,0.00047536020317007032,-0.00000312680279452231,-0.11885261252314077707,-0.00000049329401006751,-0.20131992058185405048,-1.67982118373826483371,-1.88114110432014136620,0.99999684364612273502,0.31166889203322001300,0.13471834822375744478,-0.17695054380946223516,0.18542516933218194941,-0.00002852225507792524,0.00003214235187177130,0.00000000276006149948,0.00000361733660122286,0.00000000000014186853,-0.00000361733660121948,-0.00000045699038616779,-0.00845788014302692286,-0.00004481340444700369,0.00846195447015619072,-0.00000001197022432031,-0.00045343482492010982,-0.00000107357767705200,-0.63408567700050522120,0.63453911035215337932,0.00045343335164753818,0.00000001344349680954,-0.34095346955604544092,0.27122995852789932858,-0.38781657191605500845,0.36324620910404520346,-0.00006187061580441158,0.00006295616370590297,0.00000000082765161545,0.00000108472020721482,0.00000000000004254170,-0.00000108472020721568,-0.00000013703637814971,0.02437949061928735422,0.00012913778564406991,-0.02437826886265945583,-0.00000001422882614267,-0.00054393157120756291,0.00000210854932190747,-0.76063679873586309554,0.76118072840934258849,0.00054392967347750073,0.00000001612655610628,0.75272537791425930820,0.47451047483434483087,0.72178509692008507859,-0.71320612075529743468,0.00012151522265138864,-0.00012360954314735842,-0.00000000159676762252,-0.00000209272364607323,-0.00000000000008207465,0.00000209272364606171,0.00000026438086708154,-0.00841316454869772863,-0.00004455917753675979,0.00841080744410250061,0.00000000337551873195,0.00012698731027434480,0.00000090433889231350,0.17757973374102595243,-0.17770672066188139548,-0.00012698692085608349,-0.00000000376493696957,-0.19129836599319291479,0.12829058052660982647,-0.68041105348019725874,-0.30594428010815039043,0.00005211713086652793,-0.00005302484527768839,-0.00000000069206646498,-0.00000090702230900816,-0.00000000000003557256,0.00000090702230900731,0.00000011458720073667,-0.01352104334667833356,-0.00007161982924114975,0.01352002173713301447,-0.00000001085330741072,-0.00041694426093321816,0.00000301288821422025,-0.58305706499483711536,0.58347400774746105423,0.00041694275262141724,0.00000001236161913670,0.56142701192106636565,-0.39719894463904537041,-0.95862595656011206913,-0.01915040086344776959,0.00017363235351786944,-0.00017663438842504671,-0.00000000228883408750,-0.00000299974595508136,-0.00000000000011764721,0.00000299974595507062,0.00000037896806781841,-0.02193420789537606219,-0.00011617900677790955,0.02193082918123551509,-0.00000130780133326351,-0.00000466558819212684,-0.03405412996363073319,-0.00663292252830161369,0.00663889577511484353,0.00000597324682718272,0.00000000014269370598,-0.01175962326360933952,0.00201995080442064334,0.01377957406803128476,0.00802473729449924671,-0.96253877005393251309,-0.00340579218111889282,0.00002596480362180562,0.03402947162673844450,0.00000000133460376401,-0.03402947162673843062,-0.00429905842175325962,0.01992792777757297282,0.00000208442409470913,0.01840060360552250515,-0.00000131865464067422,-0.00042160984912534494,-0.03405111707541651211,-0.58968998752313872558,0.59011290352257594893,0.00042291599944859994,0.00000001250431284269,0.54966738865745701226,-0.39517899383462473661,-0.94484638249208074967,-1.01112566356894850728,-1.96236513770041454130,0.99641757343045600503,0.00002596251478771811,0.03402647188078335855,0.00000000133448611680,-0.03402647188078335855,-0.00429867945368544047,-0.00200628011780308807,-0.00011409458268320040,0.04033143278675802024,-0.00000003080392897915,0.00032015457736834271,-0.00102152553934175909,0.44770260986199822417,-0.44802272414358212949,-0.00032011428158435363,-0.00000000949185494854,0.63413390508291433978,-0.07884367734187158749,-0.71297758242478581625,-0.36911685502985708274,0.00108375760697896175,-0.00006220126370834503,0.99847592378368521526,-1.99745428910214273266,-0.00000007833827224562,1.99745428910214251061,0.25234516650221572309,-1.16753216007580085112,-0.00011073514847769635,-1.08226737386682980713,-0.00000003927921547598,-0.00000040620812580288,-0.00102261794064441107,-0.00057130294906461031,0.00057174842423148508,0.00000044547516680892,0.00000000001217447223,-0.00080801166881634624,0.00010017491970426730,0.00090818658852063040,0.00046971973993592108,0.00102080344309411764,0.00000185377676577727,-0.00152407540628241977,-0.99745322747373932337,-0.00000003990011798488,-0.00254677252625980146,-0.00032174240015834209,0.00148857383858670635,0.00000014108249165360,0.00137990118771394899,-0.00000003832859783392,0.00003554898033483923,-0.00102249539574793854,0.04970862443595048391,-0.04974413403385761351,-0.00003550959790718984,-0.00000000105382980659,0.07040923420608655170,-0.00875443616910793858,-0.07916367037519446426,-0.04098436806401786758,0.00102786457890738803,-0.00000533085456162222,-0.00152407547113252552,-1.99745331246628810007,0.99999992166176610020,1.99745331246628787802,0.25234504312049998997,-0.12963276945839960486,-0.00001229517284808339,-0.12016566446662213519,-0.00000000095061764206,-0.00003595518846064210,-0.00000012254489647247,-0.05027992738501509823,0.05031588245808910065,0.00003595507307399877,0.00000000106600427882,-0.07121724587490289859,0.00885461108881220593,0.08007185696371509065,0.04145408780395379300,-0.00000706113581327024,0.00000718463132739949,0.00000000006485010582,0.00000008499254868421,0.00000003843811595800,-1.00000008499254766647,-0.25266678552065829910,0.13112134329698629798,0.00001243625533973699,0.12154556565433607962,0.00000000752466885476,0.00028460559703350342,0.00000096985640617950,0.39799398542604769169,-0.39827859010972443965,-0.00028460468367716381,-0.00000000843802514195,0.56372467087682776032,-0.07008924117276366106,-0.63381391204959136587,-0.32813248696583918740,0.00005589302807157379,-0.00005687040914672282,-0.00000000074518224819,-0.00000097663585448329,-0.00000000000003830274,0.00000097663585448329,1.00000012338171573312,-1.03789939061740121851,-0.00009843997562961298,-0.96210170940020767194,0.00000000752466885476,0.00028460559703350342,0.00000096985640617950,0.39799398542604769169,-0.39827859010972443965,-0.00028460468367716381,-0.00000000843802514195,0.56372467087682776032,-0.07008924117276366106,-0.63381391204959136587,-0.32813248696583918740,0.00005589302807157379,-0.00005687040914672282,-0.00000000074518224819,-0.00000097663585448329,-0.00000000000003830274,0.00000097663585448329,0.00000012338171574499,-0.03789939061740121851,-0.00009843997562961298,-0.96210170940020767194,0.00000001534574305226,0.00058042213519445462,0.00000197791656936550,0.81166541074153120139,-0.81224583101403469154,-0.00058042027250362167,-0.00000001720843377911,1.14965510356285238736,-0.14293937800128947435,-1.29259448156414236131,-0.66919048921219559389,0.00011398774667093951,-0.00011598100898359136,-0.00000000151971808044,-0.00000199174251622299,-0.00000000000007811426,0.00000199174251622299,0.00000025162357888638,-0.03790053396596568952,0.99979924238511475032,0.03789829059979247378,-0.00000000782107419750,-0.00029581653816095120,-0.00000100806016318600,-0.41367142531548345419,
 //        0.41396724090431025189,0.00029581558882645781,0.00000000877040863716,-0.58593043268602473805,0.07285013682852581329,0.65878056951455088441,0.34105800224635646201,-0.00005809471859936572,0.00005911059983686854,0.00000000077453583224,0.00000101510666173969,0.00000000000003981153,-0.00000101510666173969,-0.00000012824186314139,-0.99999885665143550817,0.00010231763925560670,-0.00000000000000022204;

    S << 0.99999550839289275128,-0.11953448993009221923,-0.03507511382533769900,-1.15497270898452586430,-0.72548517334523621169,-1.88045788232977351129,-0.00000313613298562219,0.34581508221073903320,-0.19636494495144943273,-0.54218002716218649528,-0.52562686005442804671,-1.96142389009518414156,-0.00349650447239692247,-0.00149810942174747599,-1.96342220814224210912,-0.00000007700356614603,1.96342220814224188707,0.24804577843456523945,-1.14009578637066510964,-0.00006888552072268077,-1.07137227720970806821,-0.00000315300184498529,0.88015002108073159270,0.00000054167763478932,-1.59604239631822242274,-0.28410134497676908794,-1.88014374129501615762,-0.00000312678382437963,-0.27655919960856611972,-0.11954121841399846515,0.15701798119456789049,-0.16453474231907022629,0.00003112235176898028,-0.00002851102756968388,0.00000000199094549242,0.00000260933316236503,0.00000000000010233558,-0.00000260933316237232,-0.00000032964589723581,0.00750844592756270274,0.00003976520366030648,-0.00750550694840076797,-0.00000133860526224266,0.00031548898917621587,0.96492434449702746413,0.44106968733369650293,-0.44138382836846712376,-0.00031414103475717098,-0.00000000934916124256,0.62237428181930498639,-0.07682372653745095370,-0.69919800835675460782,-0.36109211773535782042,-1.96145501244695319443,-0.00346799344482723836,-0.00149811141269296801,-1.96342481747540409387,-0.00000007700366848161,1.96342481747540409387,0.24804610808046248516,-1.14760423229822783320,-0.00010865072438298725,-1.06386677026130738177,-0.00000003190095716468,-0.00121334723347741691,0.00000051763068066185,-0.69675455042732270527,-0.30203206641187624326,0.00121338316081894015,-0.00000000402638450250,-0.29400892909669357200,-0.12708434372490276520,0.16692458537179030720,-0.17491741089563253575,0.00002983008798732061,-0.00003031581771106901,-0.00000000037033371795,-0.00000048535937074590,-0.00000000000001903534,0.00000048535937074524,0.00000006131709340852,0.00798032047508764365,0.00004227418998420155,-0.00798086715157084008,-0.00000000570190670170,-0.00021598083734974418,-0.00000051734096419313,-0.30203207469095461057,-0.69775190517337204454,0.00021602013569390157,-0.00000003359643741832,0.29421916254509239419,0.12717522291285315861,-0.16704393963223987396,0.17504250075561963995,-0.00002981451885956768,0.00003033756173038610,0.00000000039878228911,0.00000052264406811121,0.00000000000002049761,-0.00000052264406810289,-0.00000006602739552358,-0.00798600559550198368,-0.00004230441812310859,0.00798659426698612208,-0.00000312110088782061,-0.11863663168579102747,0.00000002404695412562,0.10071215410910058785,0.01793072143510716920,-0.88135712445583513919,-0.00000312275743987713,0.01744972948812764310,0.00754312531090428184,-0.00990660417722237160,0.01038266857656231119,0.00000129226378164244,0.00000180479014138520,0.00000000236127921037,0.00000309469253311165,0.00000000000012137092,-0.00000309469253311659,-0.00000039096299064421,-0.00047187454752494070,-0.00000250898632389509,0.00047536020317007032,-0.00000312680279452231,-0.11885261252314077707,-0.00000049329401006751,-0.20131992058185405048,-1.67982118373826483371,-1.88114110432014136620,0.99999684364612273502,0.31166889203322001300,0.13471834822375744478,-0.17695054380946223516,0.18542516933218194941,-0.00002852225507792524,0.00003214235187177130,0.00000000276006149948,0.00000361733660122286,0.00000000000014186853,-0.00000361733660121948,-0.00000045699038616779,-0.00845788014302692286,-0.00004481340444700369,0.00846195447015619072,-0.00000001197022432031,-0.00045343482492010982,-0.00000107357767705200,-0.63408567700050522120,0.63453911035215337932,0.00045343335164753818,0.00000001344349680954,-0.34095346955604544092,0.27122995852789932858,-0.38781657191605500845,0.36324620910404520346,-0.00006187061580441158,0.00006295616370590297,0.00000000082765161545,0.00000108472020721482,0.00000000000004254170,-0.00000108472020721568,-0.00000013703637814971,0.02437949061928735422,0.00012913778564406991,-0.02437826886265945583,-0.00000001422882614267,-0.00054393157120756291,0.00000210854932190747,-0.76063679873586309554,0.76118072840934258849,0.00054392967347750073,0.00000001612655610628,0.75272537791425930820,0.47451047483434483087,0.72178509692008507859,-0.71320612075529743468,0.00012151522265138864,-0.00012360954314735842,-0.00000000159676762252,-0.00000209272364607323,-0.00000000000008207465,0.00000209272364606171,0.00000026438086708154,-0.00841316454869772863,-0.00004455917753675979,0.00841080744410250061,0.00000000337551873195,0.00012698731027434480,0.00000090433889231350,0.17757973374102595243,-0.17770672066188139548,-0.00012698692085608349,-0.00000000376493696957,-0.19129836599319291479,0.12829058052660982647,-0.68041105348019725874,-0.30594428010815039043,0.00005211713086652793,-0.00005302484527768839,-0.00000000069206646498,-0.00000090702230900816,-0.00000000000003557256,0.00000090702230900731,0.00000011458720073667,-0.01352104334667833356,-0.00007161982924114975,0.01352002173713301447,-0.00000001085330741072,-0.00041694426093321816,0.00000301288821422025,-0.58305706499483711536,0.58347400774746105423,0.00041694275262141724,0.00000001236161913670,0.56142701192106636565,-0.39719894463904537041,-0.95862595656011206913,-0.01915040086344776959,0.00017363235351786944,-0.00017663438842504671,-0.00000000228883408750,-0.00000299974595508136,-0.00000000000011764721,0.00000299974595507062,0.00000037896806781841,-0.02193420789537606219,-0.00011617900677790955,0.02193082918123551509,-0.00000130780133326351,-0.00000466558819212684,-0.03405412996363073319,-0.00663292252830161369,0.00663889577511484353,0.00000597324682718272,0.00000000014269370598,-0.01175962326360933952,0.00201995080442064334,0.01377957406803128476,0.00802473729449924671,-0.96253877005393251309,-0.00340579218111889282,0.00002596480362180562,0.03402947162673844450,0.00000000133460376401,-0.03402947162673843062,-0.00429905842175325962,0.01992792777757297282,0.00000208442409470913,0.01840060360552250515,-0.00000131865464067422,-0.00042160984912534494,-0.03405111707541651211,-0.58968998752313872558,0.59011290352257594893,0.00042291599944859994,0.00000001250431284269,0.54966738865745701226,-0.39517899383462473661,-0.94484638249208074967,-1.01112566356894850728,-1.96236513770041454130,0.99641757343045600503,0.00002596251478771811,0.03402647188078335855,0.00000000133448611680,-0.03402647188078335855,-0.00429867945368544047,-0.00200628011780308807,-0.00011409458268320040,0.04033143278675802024,-0.00000003080392897915,0.00032015457736834271,-0.00102152553934175909,0.44770260986199822417,-0.44802272414358212949,-0.00032011428158435363,-0.00000000949185494854,0.63413390508291433978,-0.07884367734187158749,-0.71297758242478581625,-0.36911685502985708274,0.00108375760697896175,-0.00006220126370834503,0.99847592378368521526,-1.99745428910214273266,-0.00000007833827224562,1.99745428910214251061,0.25234516650221572309,-1.16753216007580085112,-0.00011073514847769635,-1.08226737386682980713,-0.00000003927921547598,-0.00000040620812580288,-0.00102261794064441107,-0.00057130294906461031,0.00057174842423148508,0.00000044547516680892,0.00000000001217447223,-0.00080801166881634624,0.00010017491970426730,0.00090818658852063040,0.00046971973993592108,0.00102080344309411764,0.00000185377676577727,-0.00152407540628241977,-0.99745322747373932337,-0.00000003990011798488,-0.00254677252625980146,-0.00032174240015834209,0.00148857383858670635,0.00000014108249165360,0.00137990118771394899,-0.00000003832859783392,0.00003554898033483923,-0.00102249539574793854,0.04970862443595048391,-0.04974413403385761351,-0.00003550959790718984,-0.00000000105382980659,0.07040923420608655170,-0.00875443616910793858,-0.07916367037519446426,-0.04098436806401786758,0.00102786457890738803,-0.00000533085456162222,-0.00152407547113252552,-1.99745331246628810007,0.99999992166176610020,1.99745331246628787802,0.25234504312049998997,-0.12963276945839960486,-0.00001229517284808339,-0.12016566446662213519,-0.00000000095061764206,-0.00003595518846064210,-0.00000012254489647247,-0.05027992738501509823,0.05031588245808910065,0.00003595507307399877,0.00000000106600427882,-0.07121724587490289859,0.00885461108881220593,0.08007185696371509065,0.04145408780395379300,-0.00000706113581327024,0.00000718463132739949,0.00000000006485010582,0.00000008499254868421,0.00000003843811595800,-1.00000008499254766647,-0.25266678552065829910,0.13112134329698629798,0.00001243625533973699,0.12154556565433607962,0.00000000752466885476,0.00028460559703350342,0.00000096985640617950,0.39799398542604769169,-0.39827859010972443965,-0.00028460468367716381,-0.00000000843802514195,0.56372467087682776032,-0.07008924117276366106,-0.63381391204959136587,-0.32813248696583918740,0.00005589302807157379,-0.00005687040914672282,-0.00000000074518224819,-0.00000097663585448329,-0.00000000000003830274,0.00000097663585448329,1.00000012338171573312,-1.03789939061740121851,-0.00009843997562961298,-0.96210170940020767194,0.00000000752466885476,0.00028460559703350342,0.00000096985640617950,0.39799398542604769169,-0.39827859010972443965,-0.00028460468367716381,-0.00000000843802514195,0.56372467087682776032,-0.07008924117276366106,-0.63381391204959136587,-0.32813248696583918740,0.00005589302807157379,-0.00005687040914672282,-0.00000000074518224819,-0.00000097663585448329,-0.00000000000003830274,0.00000097663585448329,0.00000012338171574499,-0.03789939061740121851,-0.00009843997562961298,-0.96210170940020767194,0.00000001534574305226,0.00058042213519445462,0.00000197791656936550,0.81166541074153120139,-0.81224583101403469154,-0.00058042027250362167,-0.00000001720843377911,1.14965510356285238736,-0.14293937800128947435,-1.29259448156414236131,-0.66919048921219559389,0.00011398774667093951,-0.00011598100898359136,-0.00000000151971808044,-0.00000199174251622299,-0.00000000000007811426,0.00000199174251622299,0.00000025162357888638,-0.03790053396596568952,0.99979924238511475032,0.03789829059979247378,-0.00000000782107419750,-0.00029581653816095120,-0.00000100806016318600,-0.41367142531548345419,
             0.41396724090431025189,0.00029581558882645781,0.00000000877040863716,-0.58593043268602473805,0.07285013682852581329,0.65878056951455088441,0.34105800224635646201,-0.00005809471859936572,0.00005911059983686854,0.00000000077453583224,0.00000101510666173969,0.00000000000003981153,-0.00000101510666173969,-0.00000012824186314139,-0.99999885665143550817,0.00010231763925560670,-0.00000000000000022204;
    std::cout << "S matrix: \n\n" << S.transpose() << std::endl;
    return S.transpose();

}

MyMat_G PrepareGainStage_Knob(float gain_pot, Gain_Data& G_d)
{
    Matrix<double, 21, 21> S;
    if(gain_pot < 0.5) //a = 0.2
    {
        G_d.z21 = 961.5445;
        //S3
        G_d.Z2_S3 = 100e3*0.8;
        G_d.Z1_S3 = G_d.Z2_S3 + G_d.Z3_S3;
        G_d.alpha_S3 = 2 * G_d.Z3_S3 / (G_d.Z1_S3 + G_d.Z2_S3 + G_d.Z3_S3);


        G_d.S_S3_2 = { -1 + G_d.alpha_S3, G_d.alpha_S3, -1 + G_d.alpha_S3 };
        G_d.S_S3_3 = { -G_d.alpha_S3, -G_d.alpha_S3, 1 - G_d.alpha_S3 };

        //S3P3
       //G_d.Z2_S3P3 = G_d.Z1_P3;
       G_d.Z3_S3P3 = G_d.Z1_S3;
       G_d.Z1_S3P3 = G_d.Z2_S3P3 + G_d.Z3_S3P3;
       G_d.alpha_S3P3 = (2 * G_d.Z3_S3P3) / (G_d.Z1_S3P3 + G_d.Z2_S3P3 + G_d.Z3_S3P3);

       G_d.S_S3P3_2 = { -1 + G_d.alpha_S3P3, G_d.alpha_S3P3, -1 + G_d.alpha_S3P3 };
       G_d.S_S3P3_3 = { -G_d.alpha_S3P3, -G_d.alpha_S3P3, 1 - G_d.alpha_S3P3 };

        //S << 0.99999551088396065879,-0.11981209050007742001,-0.03482005639277181708,-1.01849254273717204633,-0.86168774362322497762,-1.88018028636036671486,-0.00000313402347461562,0.27038670426253885726,-0.24781721626814764980,-0.51820392053068398130,-0.61036202938997974332,-1.96166382250260418196,-0.00351163198861389287,-0.00111835357141900032,-1.96405701554033407241,-0.00000008537943389941,1.96405701554033562672,0.36853528132689422625,-1.20045571595545252919,-0.00005908438195888341,-1.13213666629121201268,-0.00000316474592195407,0.87970329090985954767,0.00000076395378522311,-1.46569719404096243665,-0.41399980558366483718,-1.87969699962459846354,-0.00000312653929286921,-0.40301160428905979938,-0.17419833278534385679,0.22881327150371810752,-0.23976305011022738811,0.00004395001954131460,-0.00004154922741576628,0.00000000136625686740,0.00000239942577555756,0.00000000000010430533,-0.00000239942577555387,-0.00000045022779187165,0.01093623019183125912,0.00005794729575399041,-0.01093338053815952164,-0.00000132437011743111,0.00048461859006307791,0.96517917965344290909,0.44720465130379061236,-0.44768793803956052901,-0.00048328673576834369,-0.00000000748418174641,0.67339830855159865663,-0.07361888348280376526,-0.74701719203440208883,-0.37059897927975238296,-1.96170777252214545427,-0.00347008276119812643,-0.00111835493767586773,-1.96405941496610969565,-0.00000008537953820474,1.96405941496611102792,0.36853573155468605238,-1.21139194614728373800,-0.00011703167771287383,-1.12120328575305228114,-0.00000004438607809902,-0.00168826641924063364,0.00000075435602639229,-0.55818424188454973667,-0.44012744354370109123,0.00168831457172588062,-0.00000000376640739245,-0.42844070068915640626,-0.18519044847474119830,0.24325025221441679002,-0.25489282207251218182,0.00004346679292341490,-0.00004417676287209648,-0.00000000040403386143,-0.00000070956588358243,-0.00000000000003084551,0.00000070956588358984,0.00000013314280617093,0.01162430031023367789,0.00006160360201341106,-0.01162514301895428183,-0.00000000619337631434,-0.00023487508531241168,-0.00000037146219709868,-0.21677919487615790461,-0.78298589762335280007,0.00023490750046414232,-0.00000002622177546985,0.21125166485648461112,0.09131203614996862006,-0.11993962870651624086,0.12568025767659829484,-0.00002140467271643386,0.00002178232828983228,0.00000000021491844829,0.00000037744063855990,0.00000000000001640770,-0.00000037744063855733,-0.00000007082288895603,-0.00573158808832021846,-0.00003037494650721001,0.00573203635186413790,-0.00000312035984385505,-0.11860844267089984405,0.00000000959775883329,0.09248704784358696696,0.02612763796003628181,-0.88138531419632437647,-0.00000312277288547676,0.02542909640009662769,0.01099211568939736407,-0.01443698071069876056,0.01512977196228476942,0.00000048322661792124,0.00000262753545633055,0.00000000177029072883,0.00000310899165913762,0.00000000000013515084,-0.00000310899165914297,-0.00000058337059804244,-0.00068807011840241845,-0.00000365630625942065,0.00069176248079476149,-0.00000312655322016939,-0.11884331775621226335,-0.00000036186443826539,-0.12429214703257093766,-1.75685825966331643500,-1.88115040669586019995,0.99999685100533908244,0.23668076125658121800,0.10230415183936598933,-0.13437660941721499275,0.14081002963888306079,-0.00002092144609851262,0.00002440986374616283,0.00000000198520917712,0.00000348643229769752,0.00000000000015155854,-0.00000348643229770030,-0.00000065419348699847,-0.00641965820672263723,-0.00003403125276663066,0.00642379883265889896,-0.00000001742301270627,-0.00066076149950064728,-0.00000103248315051256,-0.60984869960995746752,0.61050946832349040072,0.00066076871353338011,0.00000001020897988802,-0.36435507423051793907,0.26111808581560708165,-0.37452683995387431315,0.34933084828924576559,-0.00005949452145379646,0.00006054442761713677,0.00000000059748675601,0.00000104930863084877,0.00000000000004561445,-0.00000104930863084853,-0.00000019689207004111,0.02500419065530859811,0.00013250278244946804,-0.02500294445456210934,-0.00000002076968907840,-0.00079262983442757466,0.00000215830137400513,-0.73155634739843422576,0.73234898575616147465,0.00079263835772835824,0.00000001224638818938,0.72466270868487692169,0.46237942955968303060,0.73771672087480744118,-0.72990392803835613122,0.00012436598709393044,-0.00012650351877906572,-0.00000000121643906573,-0.00000213631515298799,-0.00000000000009286766,0.00000213631515299166,0.00000040085776516732,-0.00764830225675470262,-0.00004052423392884697,0.00764576508374368788,0.00000000490264161858,0.00018505166934803947,0.00000089291113320733,0.17079312405011889964,-0.17097817776300089365,-0.00018505371288115164,-0.00000000285910848352,-0.18474291983859503219,0.13112229002150230239,-0.68413479013990241562,-0.30204812105969586211,0.00005145177014145931,-0.00005234958391636828,-0.00000000051093312775,-0.00000089730280269089,-0.00000000000003900661,0.00000089730280269114,0.00000016836972562847,-0.01369324237936916239,-0.00007256250968375001,0.01369217670680184656,-0.00000001586704745983,-0.00060757816507953511,0.00000305121250720975,-0.56076322334831529837,0.56137080799316063651,0.00060758464484720655,0.00000000938727970586,0.53991978884628200053,-0.40649828041881463925,-0.94641806926509519649,-0.03195204909805204885,0.00017581775723523631,-0.00017885310269543397,-0.00000000172737219348,-0.00000303361795568132,-0.00000000000013187427,0.00000303361795568506,0.00000056922749079621,-0.02134154463612386587,-0.00011308674361259699,0.02133794179054553444,-0.00000130803935521262,-0.00000726620432055292,-0.03405854675363165218,-0.00677797606335765485,0.00678655019150268754,0.00000857412814612302,0.00000000011552513478,-0.01260659740529393273,0.00198055853909260464,0.01458715594438754135,0.00821174388372690814,-0.96253439309122779122,-0.00340575211580356743,0.00001938298189237850,0.03404047033132269473,0.00000000147977174978,-0.03404047033132273636,-0.00638734731771649182,0.02103244710763245082,0.00000222430885466829,0.01939537202117854256,-0.00000132390640267244,-0.00061484436940008802,-0.03405549554112444199,-0.56754119941167291419,0.56815735818466328588,0.00061615877299332962,0.00000000950280484065,0.52731319144098798279,-0.40451772187972201422,-0.93183091332070755453,-1.02374030521432524132,-1.96235857533399249419,0.99641539478150098486,0.00001938125452018502,0.03403743671336701554,0.00000000147963987551,-0.03403743671336705023,-0.00638677809022569591,-0.00030909752849141256,-0.00011086243475792870,0.04073331381172407700,-0.00000001633076221849,0.00049188479438363097,-0.00076227359292538647,0.45398262736714822818,-0.45447448823106317839,-0.00049186086391446676,-0.00000000759970688119,0.68600490595689256335,-0.07559944202189636253,-0.76160434797878950874,-0.37881072316347930151,0.00082662056908205234,-0.00006433064539455882,0.99886226208043171759,-1.99809988529743232100,-0.00000008685930995452,1.99809988529743387531,0.37492307887240255981,-1.23242439325491615065,-0.00011925598656754211,-1.14059865777423086186,-0.00000002932662167596,-0.00000046665932627926,-0.00076339439494291445,-0.00043230829648845055,0.00043280427515328401,0.00000049597866485035,0.00000000000728310655,-0.00065236117851628006,0.00007166525410397533,0.00072402643262022199,0.00035975358798519058,0.00076203828121734817,0.00000138544034724977,-0.00113773730682967624,-0.99809880920350479983,-0.00000002976809968933,-0.00190119079649375038,-0.00035673907605435147,0.00117262124873229821,0.00000011339476365074,0.00108527885571632534,-0.00000002727335490630,0.00007732184979866277,-0.00076321729675164925,0.07136246371656766729,-0.07143975709843684851,-0.00007729338186910197,-0.00000000119457464286,0.10783527440742400605,-0.01188390545555647812,-0.11971917986298057091,-0.05954685553938946635,0.00077224186817211190,-0.00000899729806556742,-0.00113773737629246398,-1.99809893119433046316,0.99999991314073155557,1.99809893119433223951,0.37492289984467974673,-0.19372813896268609168,-0.00001874623515915270,-0.17929377893559469981,-0.00000000205326676966,-0.00007778850912494202,-0.00000017709819126517,-0.07179477201305611844,0.07187256137359013253,0.00007778936053395233,0.00000000120185774941,-0.10848763558594029521,0.01195557070966045236,0.12044320629560080482,0.05990660912737465899,-0.00001020358695476375,0.00001038273841281719,0.00000000006946278770,0.00000012199082560359,0.00000005709116878942,-1.00000012199082588538,-0.37527963892073412655,0.19490076021141838902,0.00001885962992280343,0.18037905779131102602,0.00000001094259268781,0.00041456294458496812,0.00000094370382626282,0.38262016365058054701,-0.38303473113262637151,-0.00041456748204536469,-0.00000000640513223833,0.57816963154946865444,-0.06371553656633989482,-0.64188516811580897947,-0.31926386762408981435,0.00005437870090994051,-0.00005533334732899139,-0.00000000054327578214,-0.00000095410310169259,-0.00000000000004147577,0.00000095410310169259,1.00000017902772286860,-1.03869625429223000346,-0.00010050975140838942,-0.96130487883863624532,0.00000001094259268781,0.00041456294458496812,0.00000094370382626282,0.38262016365058054701,-0.38303473113262637151,-0.00041456748204536469,-0.00000000640513223833,0.57816963154946865444,-0.06371553656633989482,-0.64188516811580897947,-0.31926386762408981435,0.00005437870090994051,-0.00005533334732899139,-0.00000000054327578214,-0.00000095410310169259,-0.00000000000004147577,0.00000095410310169259,0.00000017902772282830,-0.03869625429223000346,-0.00010050975140838942,-0.96130487883863624532,0.00000002232565432485,0.00084581316884868672,0.00000192539428371990,0.78064182366007639491,-0.78148764608649123886,-0.00084582242641453170,-0.00000001306808837153,1.17961215439192290688,-0.12999579579410480701,-1.30960795018602826900,-0.65137896934894157219,0.00011094629159525576,-0.00011289401153350505,-0.00000000110841988376,-0.00000194661143353966,-0.00000000000008462106,0.00000194661143353967,0.00000036526179566957,-0.03869743303467775702,0.99979493470786673370,0.03869512116136395591,-0.00000001138306163704,-0.00043125022426371865,-0.00000098169045745708,-0.39802166000949584790,
        //      0.39845291495386492286,0.00043125494436916701,0.00000000666295613320,-0.60144252284245436346,0.06628025922776489831,0.66772278207021917851,0.33211510172485181336,-0.00005656759068531524,0.00005756066420451365,0.00000000056514410162,0.00000099250833184707,0.00000000000004314528,-0.00000099250833184708,-0.00000018623407284127,-0.99999882125755235052,0.00010455554072482863,-0.00000000000000022204;
        S << 1.00000000000000000000,-0.11932040569572574529,-0.03657857601761351635,-1.36835881178712703843,-0.51231763491514048514,-1.88067644670225231351,-0.00000314760198810476,0.50664068688698649101,-0.11145569919174586060,-0.61809638607873307325,-0.39739340089199443051,-1.95994974154897372287,-0.00347168243339960594,-0.00373814123469059069,-1.95968316087419536231,-0.00000012187350051835,1.95968316087419558436,0.15703276520618089651,-1.09766342154455354141,-0.00009115700518546241,-1.01905262640932314788,0.00000000000000000000,0.88051853249725497985,0.00000025966775282223,-1.72872395545350343582,-0.15179144773540606539,-1.88051540318888021908,-0.00000312930834110131,-0.14776862981966457089,-0.06387040056410665800,0.08389822925555842636,-0.08790894051134032217,0.00001497630056412947,-0.00001523596831696136,-0.00000000049437921084,-0.00000025917335749198,-0.00000000000001611810,0.00000025917335748992,0.00000002076800464839,0.00400442019672332672,0.00002124708599559690,-0.00400470013810157611,0.00000000000000000000,0.00016106180701929253,0.96342116431463364901,0.36036514366637639739,-0.36052618717973455853,-0.00016104351337218285,-0.00000001829364700345,0.65440931670665114517,-0.04758529862763920953,-0.70199461533429152738,-0.30948446038065413610,-1.95996471784953807393,-0.00345644646508264444,-0.00373814074031137995,-1.95968290170083792034,-0.00000012187348440025,1.95968290170083792034,0.15703274443817624717,-1.10166784174127685425,-0.00011240409118105932,-1.01504792627122153448,0.00000000000000000000,-0.00082138456062226561,0.00000027605086637924,-0.83780692392687550196,-0.16137168480737959508,0.00082139126566909456,-0.00000000670504713445,-0.15709173681218452368,-0.06790015017226828931,0.08919158663991737235,-0.09345534409501483897,0.00001592119429899955,-0.00001619724516528173,-0.00000000052557088043,-0.00000027552527835625,-0.00000000000001713503,0.00000027552527835424,0.00000002207831204962,0.00425706947676753825,0.00002258761988467719,-0.00425736708037509001,0.00000000000000000000,-0.00028848828342095353,-0.00000110469692277481,-0.64548673922952637394,-0.35422470525474980541,0.00028855551564438631,-0.00000006723222340914,0.62864775803926586928,0.27172197623200688987,-0.35692578180725836878,0.37398843334680315076,-0.00006371323727416900,0.00006481793419688566,0.00000000210322301083,0.00000110259363119795,0.00000000000006857075,-0.00000110259363119318,-0.00000008835271449072,-0.01703588767108043731,-0.00009039085624804220,0.01703707861749469143,0.00000000000000000000,-0.11866008294212276875,-0.00000001638311355648,0.10908296847337180246,0.00958023707197351582,-0.88133679445454915502,-0.00000312260329396686,0.00932310699251993023,0.00402974960816161829,-0.00529335738435895552,0.00554640358367459313,-0.00000094489373491806,0.00000096127684832038,0.00000000003119166959,0.00000001635192086553,0.00000000000000101693,-0.00000001635192086571,-0.00000000131030740134,-0.00025264928004421874,-0.00000134053388908029,0.00025266694227350724,0.00000000000000000000,-0.11894857122554372553,-0.00000112108003633129,-0.53640377075615452984,-1.34464446818277627571,-1.88104823893890471531,0.99999681016448260795,0.63797086503178579431,0.27575172584016854893,-0.36221913919161730089,0.37953483693047773695,-0.00006465813100908705,0.00006577921104520605,0.00000000213441468042,0.00000111894555206348,0.00000000000006958768,-0.00000111894555205889,-0.00000008966302189206,-0.01728853695112465491,-0.00009173139013712248,0.01728974555976819927,0.00000000000000000000,-0.00024227607651417714,-0.00000091522123677467,-0.54207670170682697997,0.54231895026525067660,0.00024224855842576692,0.00000002751808826162,-0.43076602368279770516,0.23242268659336037806,-0.33681128972384133391,0.30984259071460046320,-0.00005278525414057779,0.00005370047537729073,0.00000000174248187489,0.00000091347869809076,0.00000000000005680962,-0.00000091347869809138,-0.00000007319861127665,0.02677393292216929954,0.00014205228905964730,-0.02677294624480311760,0.00000000000000000000,-0.00029062020068713494,0.00000229596902593028,-0.65024348299052214806,0.65053407018211972801,0.00029058719159894133,0.00000003300908801307,0.64502652883134725670,0.42795518700236445664,0.78292865817101697790,-0.77728636815641838353,0.00013241968571371752,-0.00013471565473945806,-0.00000000437127576615,-0.00000229159760764775,-0.00000000000014251540,0.00000229159760763722,0.00000018362963781687,-0.00548097577432131965,-0.00002907381292692794,0.00547850054693333876,0.00000000000000000000,0.00006785263859201647,0.00000085953841865497,0.15181579237731038234,-0.15188363730909890115,-0.00006784493178524431,-0.00000000770680673232,-0.16613893833284823498,0.13915829913169011633,-0.69470276253546114908,-0.29099151085362129354,0.00004957375555683629,-0.00005043329397535642,-0.00000000163646783433,-0.00000085790189746688,-0.00000000000005335327,0.00000085790189746626,0.00000006874514713626,-0.01418098216891779985,-0.00007523779512260263,0.01418005552181984125,0.00000000000000000000,-0.00022276756209511843,0.00000315550744458348,-0.49842769061321173796,0.49865043287302079911,0.00022274225981369709,0.00000002530228128075,0.47888759049849916050,-0.43288651386594545478,-0.91177410436444394914,-0.06827787901003978810,0.00018199344127068414,-0.00018514894871481474,-0.00000000600774360047,-0.00000314949950511296,-0.00000000000019586867,0.00000314949950510508,0.00000025237478495326,-0.01966195794323911950,-0.00010431160804953056,0.01965855606875318087,0.00000000000000000000,-0.00000240528684244729,-0.03402810190407912216,-0.00538167027043839202,0.00538407528410026794,0.00000240501364628690,0.00000000027319616768,-0.01217154377394747897,0.00157493847511879902,0.01374648224906526058,0.00721511695462770906,-0.96256591822346360132,-0.00340597987244444563,0.00006478581180391188,0.03396331398008275992,0.00000000211219244345,-0.03396331398008276686,-0.00272153846924876475,0.01912710636976781495,0.00000212886051968909,0.01755774819175616105,0.00000000000000000000,-0.00022517284893756574,-0.03402494639663453807,-0.50380936088365013692,0.50403450815712103061,0.00022514727345998396,0.00000002557547744844,0.46671604672455163643,-0.43131157539082665142,-0.89802762211537867643,-1.06106276205541205648,-1.96238392478219281223,0.99640887117884069379,0.00006477980406031140,0.03396016448057764814,0.00000000211199657478,-0.03396016448057766202,-0.00272128609446381162,-0.00053485157347130357,-0.00010218274752984147,0.03721630426050934193,0.00000000000000000000,0.00016346709386173987,-0.00255073378128721452,0.36574681393681474084,-0.36591026246383479004,-0.00016344852701846978,-0.00000001856684317114,0.66658086048059850270,-0.04916023710275800596,-0.71574109758335668907,-0.31669957733528181221,0.00260120037392550050,-0.00005046659263819910,0.99619707344788466230,-1.99364621568092070802,-0.00000012398567684370,1.99364621568092093007,0.15975428290742502146,-1.12079494811104463103,-0.00011453295170074839,-1.03260567446297790717,0.00000000000000000000,-0.00000052153376248289,-0.00255167226273995138,-0.00116689730931371057,0.00116741878383957651,0.00000052147452587814,0.00000000005923660443,-0.00212361634263176372,0.00015573449571809408,0.00227935083834984210,0.00100708749984902831,0.00254707541523087897,0.00000459684750905518,-0.00380292481176692804,-0.99364530332069445073,-0.00000009960479880396,-0.00635469667930554580,-0.00050921271944426663,0.00357240977407076747,0.00000036483417243490,0.00329140001988039062,0.00000000000000000000,0.00001164428738655977,-0.00255160261083630692,0.02605332309755877332,-0.02606496606236941363,-0.00001164296481053672,-0.00000000132257601599,0.04748554975900713682,-0.00350286853638423577,-0.05098841829539141335,-0.02256261070565005605,0.00255109075374743881,0.00000051185708885839,-0.00380292489795815364,-1.99364534850558272616,0.99999987601437712037,1.99364534850558294821,0.15975421341918125129,-0.07984100968078605698,-0.00000815908564812837,-0.07355867622960074459,0.00000000000000000000,-0.00001216582114904266,-0.00000006965190364457,-0.02722022040687248345,0.02723238484620899014,0.00001216443933641486,0.00000000138181262043,-0.04960916610163890184,0.00365860303210232976,0.05326776913374125372,0.02356969820549908307,-0.00000401533851655989,0.00000408499042019679,0.00000000008619122618,0.00000004518488841009,0.00000002438082410975,-1.00000004518488827543,-0.16026342613862551434,0.08341341945485682141,0.00000852391982056327,0.07685007624948113347,0.00000000000000000000,0.00015182280647518006,0.00000086882954909218,0.33969349083925598487,-0.33984529640146543539,-0.00015180556220793304,-0.00000001724426715514,0.61909531072159140752,-0.04565736856637376412,-0.66475267928796533123,-0.29413696662963179085,0.00005010962017806154,-0.00005097844972705749,-0.00000000165415713800,-0.00000086717533802424,-0.00000000000005392999,0.00000086717533802424,1.00000006948824382569,-1.04095393843025862957,-0.00010637386605262002,-0.95904699823337702380,0.00000000000000000000,0.00015182280647518006,0.00000086882954909218,0.33969349083925598487,-0.33984529640146543539,-0.00015180556220793304,-0.00000001724426715514,0.61909531072159140752,-0.04565736856637376412,-0.66475267928796533123,-0.29413696662963179085,0.00005010962017806154,-0.00005097844972705749,-0.00000000165415713800,-0.00000086717533802424,-0.00000000000005392999,0.00000086717533802424,0.00000006948824379743,-0.04095393843025862957,-0.00010637386605262002,-0.95904699823337702380,0.00000000000000000000,0.00031012871510619362,0.00000177475965542964,0.69389249408413733455,-0.69420258757434960550,-0.00031009349021101122,-0.00000003522489499393,1.26462708534994949794,-0.09326438746167026173,-1.35789147281161981518,-0.60083410156822170123,0.00010235900969741408,-0.00010413376935264714,-0.00000000337894970921,-0.00000177138059555764,-0.00000000000011016289,0.00000177138059555764,0.00000014194375841292,-0.04095491509108709766,0.99978270991581774663,0.04095300176662296232,0.00000000000000000000,-0.00015830590863101355,-0.00000090593010633746,-0.35419900324488134968,
                0.35435729117288417012,0.00015828792800307817,0.00000001798062783879,-0.64553177462835809042,0.04760701889529649761,0.69313879352365437292,0.30669713493858996589,-0.00005224938951935254,0.00005315531962558966,0.00000000172479257121,0.00000090420525753340,0.00000000000005623290,-0.00000090420525753340,-0.00000007245551461548,-0.99999902333917145558,0.00011091621812962991,0.00000000000000000000;
    }
    else if(gain_pot == 0.5) //a = 0.5
    {
        G_d.z21 = 964.6072;
        //S3
        G_d.Z2_S3 = 100e3*0.5;
        G_d.Z1_S3 = G_d.Z2_S3 + G_d.Z3_S3;
        G_d.alpha_S3 = 2 * G_d.Z3_S3 / (G_d.Z1_S3 + G_d.Z2_S3 + G_d.Z3_S3);

        G_d.S_S3_2 = { -1 + G_d.alpha_S3, G_d.alpha_S3, -1 + G_d.alpha_S3 };
        G_d.S_S3_3 = { -G_d.alpha_S3, -G_d.alpha_S3, 1 - G_d.alpha_S3 };

        //S3P3
        G_d.Z3_S3P3 = G_d.Z1_S3;
        G_d.Z1_S3P3 = G_d.Z2_S3P3 + G_d.Z3_S3P3;
        G_d.alpha_S3P3 = (2 * G_d.Z3_S3P3) / (G_d.Z1_S3P3 + G_d.Z2_S3P3 + G_d.Z3_S3P3);

        G_d.S_S3P3_2 = { -1 + G_d.alpha_S3P3, G_d.alpha_S3P3, -1 + G_d.alpha_S3P3 };
        G_d.S_S3P3_3 = { -G_d.alpha_S3P3, -G_d.alpha_S3P3, 1 - G_d.alpha_S3P3 };

     //   S << 0.99999550839289275128,-0.11953448993009221923,-0.03507511382533769900,-1.15497270898452586430,-0.72548517334523621169,-1.88045788232977351129,-0.00000313613298562219,0.34581508221073903320,-0.19636494495144943273,-0.54218002716218649528,-0.52562686005442804671,-1.96142389009518414156,-0.00349650447239692247,-0.00149810942174747599,-1.96342220814224210912,-0.00000007700356614603,1.96342220814224188707,0.24804577843456523945,-1.14009578637066510964,-0.00006888552072268077,-1.07137227720970806821,-0.00000315300184498529,0.88015002108073159270,0.00000054167763478932,-1.59604239631822242274,-0.28410134497676908794,-1.88014374129501615762,-0.00000312678382437963,-0.27655919960856611972,-0.11954121841399846515,0.15701798119456789049,-0.16453474231907022629,0.00003112235176898028,-0.00002851102756968388,0.00000000199094549242,0.00000260933316236503,0.00000000000010233558,-0.00000260933316237232,-0.00000032964589723581,0.00750844592756270274,0.00003976520366030648,-0.00750550694840076797,-0.00000133860526224266,0.00031548898917621587,0.96492434449702746413,0.44106968733369650293,-0.44138382836846712376,-0.00031414103475717098,-0.00000000934916124256,0.62237428181930498639,-0.07682372653745095370,-0.69919800835675460782,-0.36109211773535782042,-1.96145501244695319443,-0.00346799344482723836,-0.00149811141269296801,-1.96342481747540409387,-0.00000007700366848161,1.96342481747540409387,0.24804610808046248516,-1.14760423229822783320,-0.00010865072438298725,-1.06386677026130738177,-0.00000003190095716468,-0.00121334723347741691,0.00000051763068066185,-0.69675455042732270527,-0.30203206641187624326,0.00121338316081894015,-0.00000000402638450250,-0.29400892909669357200,-0.12708434372490276520,0.16692458537179030720,-0.17491741089563253575,0.00002983008798732061,-0.00003031581771106901,-0.00000000037033371795,-0.00000048535937074590,-0.00000000000001903534,0.00000048535937074524,0.00000006131709340852,0.00798032047508764365,0.00004227418998420155,-0.00798086715157084008,-0.00000000570190670170,-0.00021598083734974418,-0.00000051734096419313,-0.30203207469095461057,-0.69775190517337204454,0.00021602013569390157,-0.00000003359643741832,0.29421916254509239419,0.12717522291285315861,-0.16704393963223987396,0.17504250075561963995,-0.00002981451885956768,0.00003033756173038610,0.00000000039878228911,0.00000052264406811121,0.00000000000002049761,-0.00000052264406810289,-0.00000006602739552358,-0.00798600559550198368,-0.00004230441812310859,0.00798659426698612208,-0.00000312110088782061,-0.11863663168579102747,0.00000002404695412562,0.10071215410910058785,0.01793072143510716920,-0.88135712445583513919,-0.00000312275743987713,0.01744972948812764310,0.00754312531090428184,-0.00990660417722237160,0.01038266857656231119,0.00000129226378164244,0.00000180479014138520,0.00000000236127921037,0.00000309469253311165,0.00000000000012137092,-0.00000309469253311659,-0.00000039096299064421,-0.00047187454752494070,-0.00000250898632389509,0.00047536020317007032,-0.00000312680279452231,-0.11885261252314077707,-0.00000049329401006751,-0.20131992058185405048,-1.67982118373826483371,-1.88114110432014136620,0.99999684364612273502,0.31166889203322001300,0.13471834822375744478,-0.17695054380946223516,0.18542516933218194941,-0.00002852225507792524,0.00003214235187177130,0.00000000276006149948,0.00000361733660122286,0.00000000000014186853,-0.00000361733660121948,-0.00000045699038616779,-0.00845788014302692286,-0.00004481340444700369,0.00846195447015619072,-0.00000001197022432031,-0.00045343482492010982,-0.00000107357767705200,-0.63408567700050522120,0.63453911035215337932,0.00045343335164753818,0.00000001344349680954,-0.34095346955604544092,0.27122995852789932858,-0.38781657191605500845,0.36324620910404520346,-0.00006187061580441158,0.00006295616370590297,0.00000000082765161545,0.00000108472020721482,0.00000000000004254170,-0.00000108472020721568,-0.00000013703637814971,0.02437949061928735422,0.00012913778564406991,-0.02437826886265945583,-0.00000001422882614267,-0.00054393157120756291,0.00000210854932190747,-0.76063679873586309554,0.76118072840934258849,0.00054392967347750073,0.00000001612655610628,0.75272537791425930820,0.47451047483434483087,0.72178509692008507859,-0.71320612075529743468,0.00012151522265138864,-0.00012360954314735842,-0.00000000159676762252,-0.00000209272364607323,-0.00000000000008207465,0.00000209272364606171,0.00000026438086708154,-0.00841316454869772863,-0.00004455917753675979,0.00841080744410250061,0.00000000337551873195,0.00012698731027434480,0.00000090433889231350,0.17757973374102595243,-0.17770672066188139548,-0.00012698692085608349,-0.00000000376493696957,-0.19129836599319291479,0.12829058052660982647,-0.68041105348019725874,-0.30594428010815039043,0.00005211713086652793,-0.00005302484527768839,-0.00000000069206646498,-0.00000090702230900816,-0.00000000000003557256,0.00000090702230900731,0.00000011458720073667,-0.01352104334667833356,-0.00007161982924114975,0.01352002173713301447,-0.00000001085330741072,-0.00041694426093321816,0.00000301288821422025,-0.58305706499483711536,0.58347400774746105423,0.00041694275262141724,0.00000001236161913670,0.56142701192106636565,-0.39719894463904537041,-0.95862595656011206913,-0.01915040086344776959,0.00017363235351786944,-0.00017663438842504671,-0.00000000228883408750,-0.00000299974595508136,-0.00000000000011764721,0.00000299974595507062,0.00000037896806781841,-0.02193420789537606219,-0.00011617900677790955,0.02193082918123551509,-0.00000130780133326351,-0.00000466558819212684,-0.03405412996363073319,-0.00663292252830161369,0.00663889577511484353,0.00000597324682718272,0.00000000014269370598,-0.01175962326360933952,0.00201995080442064334,0.01377957406803128476,0.00802473729449924671,-0.96253877005393251309,-0.00340579218111889282,0.00002596480362180562,0.03402947162673844450,0.00000000133460376401,-0.03402947162673843062,-0.00429905842175325962,0.01992792777757297282,0.00000208442409470913,0.01840060360552250515,-0.00000131865464067422,-0.00042160984912534494,-0.03405111707541651211,-0.58968998752313872558,0.59011290352257594893,0.00042291599944859994,0.00000001250431284269,0.54966738865745701226,-0.39517899383462473661,-0.94484638249208074967,-1.01112566356894850728,-1.96236513770041454130,0.99641757343045600503,0.00002596251478771811,0.03402647188078335855,0.00000000133448611680,-0.03402647188078335855,-0.00429867945368544047,-0.00200628011780308807,-0.00011409458268320040,0.04033143278675802024,-0.00000003080392897915,0.00032015457736834271,-0.00102152553934175909,0.44770260986199822417,-0.44802272414358212949,-0.00032011428158435363,-0.00000000949185494854,0.63413390508291433978,-0.07884367734187158749,-0.71297758242478581625,-0.36911685502985708274,0.00108375760697896175,-0.00006220126370834503,0.99847592378368521526,-1.99745428910214273266,-0.00000007833827224562,1.99745428910214251061,0.25234516650221572309,-1.16753216007580085112,-0.00011073514847769635,-1.08226737386682980713,-0.00000003927921547598,-0.00000040620812580288,-0.00102261794064441107,-0.00057130294906461031,0.00057174842423148508,0.00000044547516680892,0.00000000001217447223,-0.00080801166881634624,0.00010017491970426730,0.00090818658852063040,0.00046971973993592108,0.00102080344309411764,0.00000185377676577727,-0.00152407540628241977,-0.99745322747373932337,-0.00000003990011798488,-0.00254677252625980146,-0.00032174240015834209,0.00148857383858670635,0.00000014108249165360,0.00137990118771394899,-0.00000003832859783392,0.00003554898033483923,-0.00102249539574793854,0.04970862443595048391,-0.04974413403385761351,-0.00003550959790718984,-0.00000000105382980659,0.07040923420608655170,-0.00875443616910793858,-0.07916367037519446426,-0.04098436806401786758,0.00102786457890738803,-0.00000533085456162222,-0.00152407547113252552,-1.99745331246628810007,0.99999992166176610020,1.99745331246628787802,0.25234504312049998997,-0.12963276945839960486,-0.00001229517284808339,-0.12016566446662213519,-0.00000000095061764206,-0.00003595518846064210,-0.00000012254489647247,-0.05027992738501509823,0.05031588245808910065,0.00003595507307399877,0.00000000106600427882,-0.07121724587490289859,0.00885461108881220593,0.08007185696371509065,0.04145408780395379300,-0.00000706113581327024,0.00000718463132739949,0.00000000006485010582,0.00000008499254868421,0.00000003843811595800,-1.00000008499254766647,-0.25266678552065829910,0.13112134329698629798,0.00001243625533973699,0.12154556565433607962,0.00000000752466885476,0.00028460559703350342,0.00000096985640617950,0.39799398542604769169,-0.39827859010972443965,-0.00028460468367716381,-0.00000000843802514195,0.56372467087682776032,-0.07008924117276366106,-0.63381391204959136587,-0.32813248696583918740,0.00005589302807157379,-0.00005687040914672282,-0.00000000074518224819,-0.00000097663585448329,-0.00000000000003830274,0.00000097663585448329,1.00000012338171573312,-1.03789939061740121851,-0.00009843997562961298,-0.96210170940020767194,0.00000000752466885476,0.00028460559703350342,0.00000096985640617950,0.39799398542604769169,-0.39827859010972443965,-0.00028460468367716381,-0.00000000843802514195,0.56372467087682776032,-0.07008924117276366106,-0.63381391204959136587,-0.32813248696583918740,0.00005589302807157379,-0.00005687040914672282,-0.00000000074518224819,-0.00000097663585448329,-0.00000000000003830274,0.00000097663585448329,0.00000012338171574499,-0.03789939061740121851,-0.00009843997562961298,-0.96210170940020767194,0.00000001534574305226,0.00058042213519445462,0.00000197791656936550,0.81166541074153120139,-0.81224583101403469154,-0.00058042027250362167,-0.00000001720843377911,1.14965510356285238736,-0.14293937800128947435,-1.29259448156414236131,-0.66919048921219559389,0.00011398774667093951,-0.00011598100898359136,-0.00000000151971808044,-0.00000199174251622299,-0.00000000000007811426,0.00000199174251622299,0.00000025162357888638,-0.03790053396596568952,0.99979924238511475032,0.03789829059979247378,-0.00000000782107419750,-0.00029581653816095120,-0.00000100806016318600,-0.41367142531548345419,
     //           0.41396724090431025189,0.00029581558882645781,0.00000000877040863716,-0.58593043268602473805,0.07285013682852581329,0.65878056951455088441,0.34105800224635646201,-0.00005809471859936572,0.00005911059983686854,0.00000000077453583224,0.00000101510666173969,0.00000000000003981153,-0.00000101510666173969,-0.00000012824186314139,-0.99999885665143550817,0.00010231763925560670,-0.00000000000000022204;
        S << 1.00000000000000000000,-0.11953475838300296752,-0.03507519259733408307,-1.15497530468899189948,-0.72548680078789629100,-1.88046210547688885661,-0.00000313614002873719,0.34581585621515431583,-0.19636538562252675577,-0.54218124183768001689,-0.52562803898083532150,-1.96142829507806171208,-0.00349651232461136319,-0.00149811278621449196,-1.96342661761271308762,-0.00000007700373908130,1.96342661761271175536,0.24804633549790630620,-1.14009835129626369010,-0.00006888567496710162,-1.07137467881809422821,0.00000000000000000000,0.88014983263406731950,0.00000048638156145848,-1.59604421715087774203,-0.28410248869435383856,-1.88014670584521947916,-0.00000312678876850695,-0.27655865444798272135,-0.11954152798192008156,0.15701712646606391655,-0.16453557096143348049,0.00002803015826126207,-0.00002851653982271163,-0.00000000037083069716,-0.00000048601071170069,-0.00000000000001906088,0.00000048601071170110,0.00000006139937951782,0.00750664853001489080,0.00003976509506519514,-0.00750719594012516905,0.00000000000000000000,0.00031540898292968105,0.96492432102110448078,0.44106891246188600908,-0.44138431209354245244,-0.00031539963166935057,-0.00000000935126023024,0.62237451066313698167,-0.07682385764060666034,-0.69919836830374393344,-0.36109246801940186877,-1.96145632523632285071,-0.00346799578478865136,-0.00149811241538379465,-1.96342613160200119005,-0.00000007700372002042,1.96342613160199985778,0.24804627409852678110,-1.14760499982627850457,-0.00010865077003229675,-1.06386748287796883972,0.00000000000000000000,-0.00121334914012388782,0.00000051707121452523,-0.69675456886355591202,-0.30203207796988223999,0.00121335316655840023,-0.00000000402643452514,-0.29400892360035718598,-0.12708434685458969149,0.16692457674576774429,-0.17491741926824982967,0.00002979880226562588,-0.00003031587348013768,-0.00000000039422933384,-0.00000051667696493418,-0.00000000000002026358,0.00000051667696493125,0.00000006527355116699,0.00798030225653630770,0.00004227418888886328,-0.00798088420707267036,0.00000000000000000000,-0.00021598117812782926,-0.00000051744096189767,-0.30203207796987829870,-0.69775190725553892790,0.00021601477457448538,-0.00000003359644635960,0.29421916355060329096,0.12717522235058706381,-0.16704394120001683777,0.17504249924566669949,-0.00002982011079821710,0.00003033755176001468,0.00000000039451123942,0.00000051704643037866,0.00000000000002027807,-0.00000051704643037841,-0.00000006532022698846,-0.00798600881240820425,-0.00004230441832292212,0.00798659117908585500,0.00000000000000000000,-0.11863681822580876557,-0.00000003068965306876,0.10071035171267810060,0.01792958927552840837,-0.88136005901177805200,-0.00000312276233398181,0.01745026915237445075,0.00754281887266961514,-0.00990745027970388673,0.01038184830681631622,-0.00000176864400435762,0.00000179933365742582,0.00000000002339863668,0.00000003066625323299,0.00000000000000120270,-0.00000003066625323040,-0.00000000387417164921,-0.00047365372652141702,-0.00000250909382366816,0.00047368826694749530,0.00000000000000000000,-0.11885279940393658760,-0.00000054813061496643,-0.20132172625720018422,-1.67982231798001047096,-1.88114404423720338322,0.99999684364121965707,0.31166943270297770008,0.13471804122325670150,-0.17695139147972074878,0.18542434755248304867,-0.00003158875480257472,0.00003213688541744050,0.00000000041790987610,0.00000054771268361165,0.00000000000002148077,-0.00000054771268360880,-0.00000006919439863766,-0.00845966253892962289,-0.00004481351214659028,0.00846027944603335025,0.00000000000000000000,-0.00045343554037926398,-0.00000107378760612026,-0.63408568395541475837,0.63453910605231456099,0.00045342209690108469,0.00000001344347804029,-0.34095346754614386242,0.27122995736007088352,-0.38781657509378486548,0.36324620599293655498,-0.00006188235517889061,0.00006295614278492147,0.00000000081868524248,0.00000107296887879663,0.00000000000004208083,-0.00000107296887879782,-0.00000013555179302433,0.02437948369353455658,0.00012913778524223184,-0.02437827517282064801,0.00000000000000000000,-0.00054393242161679444,0.00000210829978254531,-0.76063680693826274393,0.76118072323334207141,0.00054391629508283022,0.00000001612653379417,0.75272538039518332997,0.47451047343475238893,0.72178509303956972509,-0.71320612450685305639,0.00012150126824279645,-0.00012360956802507354,-0.00000000160742581574,-0.00000210669227410947,-0.00000000000008262248,0.00000210669227410789,0.00000026614557117983,-0.00841317262459004636,-0.00004455917803044643,0.00841079978666212785,0.00000000000000000000,0.00012698751203700897,0.00000090439809085950,0.17757973571377685951,-0.17770671946088312243,-0.00012698374710529397,-0.00000000376493167702,-0.19129836654365725557,0.12829058085390054877,-0.68041105260244183484,-0.30594427924033618105,0.00005212044128902959,-0.00005302483937976491,-0.00000000068953801114,-0.00000090370851740614,-0.00000000000003544260,0.00000090370851740495,0.00000011416855821844,-0.01352104136582256769,-0.00007161982913068302,0.01352002348871149742,0.00000000000000000000,-0.00041694490957978544,0.00000301269787340350,-0.58305707122448591218,0.58347400377245883796,0.00041693254797753624,0.00000001236160211715,0.56142701385152604665,-0.39719894571134717332,-0.95862595956287233179,-0.01915040374718923744,0.00017362170953185135,-0.00017663440740483866,-0.00000000229696382688,-0.00000301040079151401,-0.00000000000011806508,0.00000301040079151142,0.00000038031412939808,-0.02193421399041261405,-0.00011617900716112945,0.02193082327537362181,0.00000000000000000000,-0.00000474375202723017,-0.03405415289932234996,-0.00663367773550382553,0.00663842134690089195,0.00000474361138425139,0.00000000014064298126,-0.01175939708922373907,0.00201982239535173410,0.01377921948457530403,0.00802439355969300321,-0.96254005263318997976,-0.00340579446749517470,0.00002596382400485586,0.03402818774076409036,0.00000000133455341121,-0.03402818774076406955,-0.00429889622408909360,0.01992718234359310697,0.00000208437904243325,0.01839990295581348662,0.00000000000000000000,-0.00042168866160701562,-0.03405114020144894144,-0.58969074895998974117,0.59011242511935979582,0.00042167615936178761,0.00000001250224509841,0.54966761676230235789,-0.39517912331599541753,-0.94484674007829705378,-1.01112601018749614923,-1.96236643092365814489,0.99641757112509998784,0.00002596152704102897,0.03402517733997257460,0.00000000133443534613,-0.03402517733997255378,-0.00429851590995969542,-0.00200703164681950534,-0.00011409462811869620,0.04033072623118710842,0.00000000000000000000,0.00032015273495691117,-0.00102152607957319745,0.44770259019738978257,-0.44802273344044341030,-0.00032014324305360204,-0.00000000949190321149,0.63413390775236067043,-0.07884368003595840224,-0.71297758778831921145,-0.36911686157909490147,0.00108372739686679554,-0.00006220131729347689,0.99847592376061133912,-1.99745431934276562735,-0.00000007833827343163,1.99745431934276385100,0.25234517032261588598,-1.16753218216987186828,-0.00011073514907472999,-1.08226738583378234715,0.00000000000000000000,-0.00000040855573985855,-0.00102261862950742979,-0.00057132562993505705,0.00057173417356202853,0.00000040854362697881,0.00000000001211287962,-0.00080800487374114635,0.00010017106274395043,0.00090817593648510550,0.00046970941483565049,0.00102076492141212776,0.00000185370809530502,-0.00152407543570476801,-0.99745326603466910598,-0.00000003990011949720,-0.00254673396533179955,-0.00032173752862568663,0.00148855145328359931,0.00000014108113817444,0.00137988014055421323,0.00000000000000000000,0.00003554668938606896,-0.00102249606793992139,0.04970860209339465763,-0.04974414772889085290,-0.00003554563549615404,-0.00000000105388990410,0.07040924053841705887,-0.00875443989563633000,-0.07916368043405337673,-0.04098437796560435581,0.00102782698948000826,-0.00000533092154007019,-0.00152407549984280664,-1.99745335009398261583,0.99999992166176454589,1.99745335009398128356,0.25234504787413392091,-0.12963279181103670723,-0.00001229517411671702,-0.12016568449531453422,0.00000000000000000000,-0.00003595524512592751,-0.00000012256156750830,-0.05027992772332971066,0.05031588190245288306,0.00003595417912313285,0.00000000106600278372,-0.07121724541215820881,0.00885461095838028026,0.08007185637053848559,0.04145408738044000646,-0.00000706206806788026,0.00000718462963537521,0.00000000006413803871,0.00000008405931353273,0.00000003843811592140,-1.00000008405931328781,-0.25266678540275960829,0.13112134326432028919,0.00001243625525489146,0.12154556463586875525,0.00000000000000000000,0.00028460604557084220,0.00000096998836672398,0.39799398810399516657,-0.39827858571155250189,-0.00028459760755744797,-0.00000000843801330739,0.56372466721394365319,-0.07008924014032207050,-0.63381390735426579308,-0.32813248361349051097,0.00005590040738678743,-0.00005687039575340671,-0.00000000073954584379,-0.00000096924878286721,-0.00000000000003801302,0.00000096924878286720,1.00000012244848202059,-1.03789939035883493901,-0.00009843997495801299,-0.96210170133846784069,0.00000000000000000000,0.00028460604557084220,0.00000096998836672398,0.39799398810399516657,-0.39827858571155250189,-0.00028459760755744797,-0.00000000843801330739,0.56372466721394365319,-0.07008924014032207050,-0.63381390735426579308,-0.32813248361349051097,0.00005590040738678743,-0.00005687039575340671,-0.00000000073954584379,-0.00000096924878286721,-0.00000000000003801302,0.00000096924878286720,0.00000012244848196483,-0.03789939035883493901,-0.00009843997495801299,-0.96210170133846784069,0.00000000000000000000,0.00058042305241627298,0.00000197818569697976,0.81166541966919170115,-0.81224582551319779444,-0.00058040584400637866,-0.00000001720840971730,1.14965510100248646808,-0.14293937650617036250,-1.29259447750865708038,-0.66919048523327273603,0.00011400279646792019,-0.00011598098216468637,-0.00000000150822325363,-0.00000197667739620277,-0.00000000000007752342,0.00000197667739620277,0.00000024972035124277,-0.03790052505935712773,0.99979924238562711825,0.03789829866153214544,0.00000000000000000000,-0.00029581700684543077,-0.00000100819733025578,-0.41367143156519647906,
                0.41396723980164523704,0.00029580823644893064,0.00000000877039640991,-0.58593043378854281489,0.07285013636584829200,0.65878057015439128730,0.34105800161978222507,-0.00005810238908113276,0.00005911058641127967,0.00000000076867740984,0.00000100742861333557,0.00000000000003951040,-0.00000100742861333557,-0.00000012727186927794,-0.99999886529947779046,0.00010231763941490188,0.00000000000000000000;
    }
    else //a = 0.8
    {
        G_d.z21 =   961.5544;
        //S3
        G_d.Z2_S3 = 100e3*0.34;
        G_d.Z1_S3 = G_d.Z2_S3 + G_d.Z3_S3;
        G_d.alpha_S3 = 2 * G_d.Z3_S3 / (G_d.Z1_S3 + G_d.Z2_S3 + G_d.Z3_S3);

        G_d.S_S3_2 = { -1 + G_d.alpha_S3, G_d.alpha_S3, -1 + G_d.alpha_S3 };
        G_d.S_S3_3 = { -G_d.alpha_S3, -G_d.alpha_S3, 1 - G_d.alpha_S3 };

        //S3P3
        G_d.Z3_S3P3 = G_d.Z1_S3;
        G_d.Z1_S3P3 = G_d.Z2_S3P3 + G_d.Z3_S3P3;
        G_d.alpha_S3P3 = (2 * G_d.Z3_S3P3) / (G_d.Z1_S3P3 + G_d.Z2_S3P3 + G_d.Z3_S3P3);

        G_d.S_S3P3_2 = { -1 + G_d.alpha_S3P3, G_d.alpha_S3P3, -1 + G_d.alpha_S3P3 };
        G_d.S_S3P3_3 = { -G_d.alpha_S3P3, -G_d.alpha_S3P3, 1 - G_d.alpha_S3P3 };

        //S << 0.99999545630241204464,-0.11932013461745974436,-0.03657849291661728619,-1.36835570231047620737,-0.51231647177962469364,-1.88067217409006381956,-0.00000314759483726816,0.50663953728353705586,-0.11145544608505440765,-0.61809498336859169942,-0.39739249874302284837,-1.95994528883937757513,-0.00347167454637791655,-0.00373813274219894111,-1.95967870877037264599,-0.00000012187322364018,1.95967870877037242394,0.15703240845148286331,-1.09766092563871509036,-0.00009115679833238309,-1.01905031345636354345,-0.00000314331070577308,0.88051872002781139681,0.00000031715666783364,-1.72872180486201343363,-0.15179064255168861486,-1.88051244741366518909,-0.00000312930339415593,-0.14776942607868931434,-0.06387022539456704839,0.08389920068412277943,-0.08790831594849421449,0.00001805666607910799,-0.00001523051202911524,0.00000000538069047012,0.00000282077317205546,0.00000000000017542504,-0.00000282077317204533,-0.00000022603338134930,0.00400614535388121775,0.00002124722926204314,-0.00400309854715239812,-0.00000140038688218309,0.00016114535472887460,0.96342118992671488265,0.36036610255153694871,-0.36052582922793613429,-0.00015972667639851024,-0.00000001829144311223,0.65440896336222620366,-0.04758522069048734537,-0.70199418405271452048,-0.30948418279452866164,-1.95996334550545658892,-0.00345644403434880150,-0.00373813812288941068,-1.95968152954354435380,-0.00000012187339906522,1.95968152954354457584,0.15703263448486423637,-1.10166707099259619795,-0.00011240402759442619,-1.01504721490921112625,-0.00000002159840002145,-0.00082138327205588050,0.00000027644588574503,-0.83780690914650168821,-0.16137167927799794809,0.00082141157546882849,-0.00000000670501314303,-0.15709174227761796283,-0.06790014896907056730,0.08919159330854987966,-0.09345533980627679371,0.00001594236018891103,-0.00001619720767437301,-0.00000000048520194558,-0.00000025436226794865,-0.00000000000001581889,0.00000025436226795408,0.00000002038248381087,0.00425708133976407128,0.00002258762086808947,-0.00425735608453166586,-0.00000000763197541002,-0.00028848782810151171,-0.00000110455733941239,-0.64548673402084388862,-0.35422470328684463325,0.00028856269228837503,-0.00000006723221139727,0.62864775608239842342,0.27172197665905578612,-0.35692577942334174912,0.37398843487443178546,-0.00006370575813200937,0.00006481794744672077,0.00000000211748771187,0.00000111007175807248,0.00000000000006903582,-0.00000111007175808013,-0.00000008895194959518,-0.01703588351886549737,-0.00009039085589614474,0.01703708254264221442,-0.00000312171230575163,-0.11865989670013274426,0.00000004071078208700,0.10908510428448846274,0.00958103672630931762,-0.88133385898913418899,-0.00000312259838101290,0.00932231619892864329,0.00402992357450349462,-0.00529239262442710023,0.00554702385778253586,0.00000211430589021130,0.00000096669564525775,0.00000000586589241569,0.00000307513544000166,0.00000000000019124394,-0.00000307513543999942,-0.00000024641586516017,-0.00025093598588285358,-0.00000134039160604636,0.00025425753737926769,-0.00000312934428116165,-0.11894838452823425223,-0.00000106384655732539,-0.53640162973635541199,-1.34464366656053524451,-1.88104529629684580350,0.99999681016940755729,0.63797007228132707191,0.27575190023355927726,-0.36221817204776884935,0.37953545873221428142,-0.00006159145224179809,0.00006578464309197852,0.00000000798338012756,0.00000418520719807414,0.00000000000026027975,-0.00000418520719807955,-0.00000033536781475535,-0.01728681950474835263,-0.00009173124750219111,0.01729134008002148129,-0.00000000640894795804,-0.00024227569414596978,-0.00000091510402162941,-0.54207669730166174737,0.54231895188665879548,0.00024225458499545923,0.00000002751809834700,-0.43076602526933371884,0.23242268694779044669,-0.33681128778287550141,0.30984259197046820633,-0.00005277897352973402,0.00005370048649916161,0.00000000175446065111,0.00000091975845173703,0.00000000000005720016,-0.00000091975845173553,-0.00000007370181868244,0.02677393649689070732,0.00014205228934540347,-0.02677294303656309674,-0.00000000755747665339,-0.00029061974980839901,0.00000229610724678819,-0.65024347782399616325,0.65053407212218772315,0.00029059429818499436,0.00000003300909990724,0.64502652690931738810,0.42795518742408322765,0.78292866051476694977,-0.77728636665117678550,0.00013242709185061919,-0.00013471564162025545,-0.00000000435715030855,-0.00000228419247775644,-0.00000000000014205487,0.00000228419247777258,0.00000018303625208872,-0.00548097163826113780,-0.00002907381258116923,0.00547850440938922427,0.00000000181807468260,0.00006785253012051040,0.00000085950516733623,0.15181579112267840070,-0.15188363776406293981,-0.00006784664138556529,-0.00000000770680959306,-0.16613893789187941796,0.13915829903181764493,-0.69470276307630274282,-0.29099151120556021599,0.00004957197388776253,-0.00005043329712963239,-0.00000000163986594424,-0.00000085968332260959,-0.00000000000005346406,0.00000085968332261109,0.00000006888789578160,-0.01418098319707667906,-0.00007523779520210237,0.01418005462580482733,-0.00000000573940197079,-0.00022276721968788861,0.00000315561241412403,-0.49842768670131776254,0.49865043435812483885,0.00022274765679942905,0.00000002530229031419,0.47888758901743794238,-0.43288651354409912742,-0.91177410256153568202,-0.06827787785673700149,0.00018199906573837261,-0.00018514893874988772,-0.00000000599701625280,-0.00000314387580036740,-0.00000000000019551893,0.00000314387580038245,0.00000025192414787022,-0.01966195483533781860,-0.00010431160778327160,0.01965855903519404813,-0.00000130673942287055,-0.00000232732650906378,-0.03402807800474526301,-0.00538077623955319963,0.00538441003023752782,0.00000363379068421162,0.00000000027525271617,-0.01217187482188459603,0.00157501129868805310,0.01374688612057184921,0.00721537661096710754,-0.96256463765165478641,-0.00340597760415027422,0.00006478825419217129,0.03396459437770387585,0.00000000211227207190,-0.03396459437770388973,-0.00272164106970123731,0.01912782351223014585,0.00000212892008308340,0.01755841404744705458,-0.00000131247882484134,-0.00022509454619695237,-0.03402492239233113891,-0.50380846294087100468,0.50403484438836232417,0.00022638144748364069,0.00000002557754303036,0.46671571419555335503,-0.43131150224541109361,-0.89802721644096372700,-1.06106250124576995120,-1.96238263858591643896,0.99640887345709983069,0.00006478225717591849,0.03396145050190350900,0.00000000211207655298,-0.03396145050190350900,-0.00272138914555336694,-0.00053413132310767091,-0.00010218268770018818,0.03721697308264110271,-0.00000009364745931254,0.00016347268123793838,-0.00255073206853985825,0.36574687879109013533,-0.36591023925817356410,-0.00016336046708272185,-0.00000001856669582840,0.66658083818411084653,-0.04916023198917539999,-0.71574107017328625346,-0.31669955940549576745,0.00260129214619782582,-0.00005046643019852734,0.99619707362291842756,-1.99364612392124840312,-0.00000012398567113713,1.99364612392124840312,0.15975427555456545026,-1.12079489450482649993,-0.00011453294767750961,-1.03260562895665830574,-0.00000009799771280388,-0.00000051568720017367,-0.00255167047043156547,-0.00116683026379132081,0.00116744388931350131,0.00000061362552213737,0.00000000005939083345,-0.00212364117199243408,0.00015573995725518233,0.00227938112924761611,0.00100710697383124526,0.00254717145052643515,0.00000459701761789854,-0.00380292462860228357,-0.99364520729846095293,-0.00000009960479283230,-0.00635479270153917024,-0.00050922041387016590,0.00357246355128023685,0.00000036483863980508,0.00329144995933658684,-0.00000009767497952632,0.00001165011472056805,-0.00255160082443033325,0.02605338998051844740,-0.02606494109783713542,-0.00001155111731874446,-0.00000000132242229785,0.04748552511755295413,-0.00350286310066090251,-0.05098838821821385231,-0.02256259134622730714,0.00255118647278108944,0.00000051202662874715,-0.00380292471539672109,-1.99364525279957671700,0.99999987601438300455,1.99364525279957671700,0.15975420575009519064,-0.07984095591626250155,-0.00000815908121370701,-0.07355862661902611011,-0.00000000032273327756,-0.00001216580192074171,-0.00000006964600123179,-0.02722022024430977016,0.02723238498715063738,0.00001216474284088184,0.00000000138181313130,-0.04960916628954539082,0.00365860305791608454,0.05326776934746146885,0.02356969832005855262,-0.00000401502225465412,0.00000408499098915139,0.00000000008679443772,0.00000004550111603143,0.00000002438082412942,-1.00000004550111576407,-0.16026342616396535568,0.08341341946754272929,0.00000852391985351209,0.07685007657836269435,0.00000000402752021379,0.00015182256651737037,0.00000086875589047505,0.33969348881057165324,-0.33984529816033648419,-0.00015180934976397739,-0.00000001724427353056,0.61909531306655785077,-0.04565736888851450181,-0.66475268195507242197,-0.29413696805926842215,0.00005010567341673683,-0.00005097845682727448,-0.00000000166168486123,-0.00000087112167165215,-0.00000000000005417541,0.00000087112167165215,1.00000006980447020410,-1.04095393858856399838,-0.00010637386646380261,-0.95904700233763218176,0.00000000402752021379,0.00015182256651737037,0.00000086875589047505,0.33969348881057165324,-0.33984529816033648419,-0.00015180934976397739,-0.00000001724427353056,0.61909531306655785077,-0.04565736888851450181,-0.66475268195507242197,-0.29413696805926842215,0.00005010567341673683,-0.00005097845682727448,-0.00000000166168486123,-0.00000087112167165215,-0.00000000000005417541,0.00000087112167165215,0.00000006980447026424,-0.04095393858856399838,-0.00010637386646380261,-0.95904700233763218176,0.00000000822702264064,0.00031012822426648018,0.00000177460918896563,0.69389248842434014808,-0.69420258965072179080,-0.00031010122638102451,-0.00000003522490794006,1.26462708737745432863,-0.09326438791597280176,-1.35789147529342724141,-0.60083410317602847783,0.00010235094741749654,-0.00010413378362879400,-0.00000000339432659535,-0.00000177944177434662,-0.00000000000011066421,0.00000177944177434662,0.00000014258971446404,-0.04095491969396738985,0.99978270991545248325,0.04095299766236792233,-0.00000000419950242686,-0.00015830565774910981,-0.00000090585329849058,-0.35419899961376843933,
        //        0.35435729149038525110,0.00015829187661704712,0.00000001798063440950,-0.64553177431089647786,0.04760701902745830688,0.69313879333835470842,0.30669713511676000017,-0.00005224527400075972,0.00005315532680151952,0.00000000173264173412,0.00000090832010269448,0.00000000000005648880,-0.00000090832010269448,-0.00000007278524419981,-0.99999901889459652526,0.00011091621808370323,0.00000000000000000000;

        S << 1.00000000000000000000,-0.12020810965028617956,-0.03469795509869650491,-0.83863730881599563016,-1.04115144800679093606,-1.87978875682272961178,-0.00000313352690442605,0.19784650141610629626,-0.31286114883861027014,-0.51070765025471465126,-0.72476175467021131116,-1.96177036687641659363,-0.00353167802490180101,-0.00093676806573330881,-1.96436516312011955065,-0.00000011371545373851,1.96436516312011621999,0.58608481979378102000,-1.31139849290356780287,-0.00005052077596518869,-1.23905160372578415640,0.00000000000000000000,0.87901656122116855752,0.00000103882867840377,-1.27232692446117234830,-0.60668650995094020040,-1.87901343441205748164,-0.00000312680903144198,-0.59059861805932367673,-0.25527596511821254444,0.33532265294111246456,-0.35135277681247906179,0.00005985600062812247,-0.00006089482930663135,-0.00000000049516130827,-0.00000103833345699045,-0.00000000000006010825,0.00000103833345698510,0.00000030979549446721,0.01600475065917434866,0.00008491991248569442,-0.01600609878818591222,0.00000000000000000000,0.00077532912854521977,0.96530100607262503409,0.43368961564517655161,-0.43446493805585056913,-0.00077532241067217438,-0.00000000671787298406,0.78844511947543005626,-0.05758518372039769101,-0.84603030319582717134,-0.37340897785773224937,-1.96183022287704456055,-0.00347078319559516969,-0.00093676757057200059,-1.96436412478666233561,-0.00000011371539363025,1.96436412478665900494,0.58608450999828642924,-1.32740324356274208562,-0.00013544068845088310,-1.22304550493759833785,0.00000000000000000000,-0.00241812971589731905,0.00000110437795754088,-0.35261059076976453142,-0.64497127546643107099,0.00241813376385496392,-0.00000000404795762790,-0.62786493008750554612,-0.27138367935677670806,0.35648125073073000380,-0.37352286291204850333,0.00006363286756971437,-0.00006473724552714465,-0.00000000052640560051,-0.00000110385148805016,-0.00000000000006390104,0.00000110385148803504,0.00000032934334847220,0.01701463793923251380,0.00009027829271099306,-0.01701607113413292766,0.00000000000000000000,-0.00028826055822244216,-0.00000027658807336214,-0.16124281886660701835,-0.83846889807291757890,0.00028828306052428233,-0.00000002250230165697,0.15724684666019722590,0.06796721041251291284,-0.08927963624768466000,0.09354765576765519675,-0.00001593665657979723,0.00001621324465310021,0.00000000013183666865,0.00000027645622068734,0.00000000000001600382,-0.00000027645622068880,-0.00000008248303183401,-0.00426126390374500542,-0.00002260992160955930,0.00426162284301353448,0.00000000000000000000,-0.11856530906293408223,-0.00000006554927913696,0.08028366630859211373,0.03828476551549081508,-0.88143156817591261643,-0.00000312276107381408,0.03726631202818191102,0.01610771423856419485,-0.02115859778961763638,0.02217008609956935480,-0.00000377686694137143,0.00000384241622051313,0.00000000003124429224,0.00000006551803106149,0.00000000000000379278,-0.00000006551803105101,-0.00000001954785400530,-0.00100988728005816731,-0.00000535838022529865,0.00100997234594701283,0.00000000000000000000,-0.11885356962115653512,-0.00000034213735249910,-0.08095915255801489074,-1.80018413255742659729,-1.88114328511538819733,0.99999685473662447421,0.19451315868837912304,0.08407492465107711810,-0.11043823403730229638,0.11571774186722454114,-0.00001971352352116866,0.00002005566087361334,0.00000000016308096089,0.00000034197425174883,0.00000000000001979660,-0.00000034197425173981,-0.00000010203088583932,-0.00527115118380317316,-0.00002796830183485795,0.00527159518896054731,0.00000000000000000000,-0.00096832421341233404,-0.00000091659921860291,-0.54164372325684151388,0.54261203908016619746,0.00096831582332496417,0.00000000839008729790,-0.43048068648383308599,0.23254600527226781947,-0.33697330824389909454,0.31001231230573272901,-0.00005281329303400320,0.00005372989225267235,0.00000000043690021047,0.00000091616226535605,0.00000000000005303587,-0.00000091616226535673,-0.00000027334469490418,0.02676644429215006143,0.00014201126077706511,-0.02676525478513677031,0.00000000000000000000,-0.00116154494426254297,0.00000229756524950180,-0.64972404864631594368,0.65088558352632019943,0.00116153488000571726,0.00000001006425673117,0.64536890973613025846,0.42810310495844250411,0.78273419522231391099,-0.77708283098543651235,0.00013238281718335344,-0.00013468038243291734,-0.00000000109514247963,-0.00000229646997409442,-0.00000000000013294072,0.00000229646997407923,0.00000068517107520999,-0.00549054244917254134,-0.00002912304645651275,0.00548756080799031251,0.00000000000000000000,0.00027119209770871743,0.00000086050185006354,0.15169454144201402479,-0.15196573118996747898,-0.00027118974795296277,-0.00000000234975573549,-0.16621883177531704412,0.13912376068847975841,-0.69465740753620308645,-0.29103905269307156489,0.00004958103328189226,-0.00005044153513198830,-0.00000000041016120435,-0.00000086009163906962,-0.00000000000004978998,0.00000086009163906894,0.00000025661555333693,-0.01417898863495904889,-0.00007522630787720503,0.01417787192771685634,0.00000000000000000000,-0.00089035284655382548,0.00000315806709956801,-0.49802950720430183562,0.49891985233635272046,0.00089034513205275433,0.00000000771450099569,0.47915007796081326985,-0.43277313435307773748,-0.91192321231388939751,-0.06812188367850802173,0.00018196385046529220,-0.00018512191756490538,-0.00000000150530368398,-0.00000315656161316429,-0.00000000000018273071,0.00000315656161314829,0.00000094178662854695,-0.01966953108413159110,-0.00010434935433371776,0.01966543273570716885,0.00000000000000000000,-0.00001189417407087596,-0.03406068148837694542,-0.00665314843890310766,0.00666504250991481473,0.00001189407101329062,0.00000000010305758899,-0.01449497620920808978,0.00174805021067001129,0.01624302641987830295,0.00832272385139381544,-0.96253358706254510402,-0.00340573144909271826,0.00001623514248011051,0.03404444437509254046,0.00000000197080436574,-0.03404444437509246413,-0.01015744547966990902,0.02303934482965611791,0.00000252817372416324,0.02116254699591063257,0.00000000000000000000,-0.00090224702062470150,-0.03405752342127738030,-0.50468265564320502481,0.50558489484626756294,0.00090223920306604498,0.00000000781755858467,0.46465510175160518180,-0.43102508414240769952,-0.89568018589401099394,-1.05979915982711414557,-1.96235162321207989855,0.99640914663334234636,0.00001623363717642653,0.03404128781347937754,0.00000000197062163503,-0.03404128781347931509,-0.01015650369304136290,0.00336981374552452811,-0.00010182118060955453,0.04082797973161780142,0.00000000000000000000,0.00078722330261609590,-0.00063831243899796118,0.44034276408407962977,-0.44112998056576535610,-0.00078721648168546504,-0.00000000682093057305,0.80294009568463819981,-0.05933323393106770122,-0.86227332961570535286,-0.38173170170912607002,0.00070336418550035406,-0.00006505174650245182,0.99904699728694790206,-1.99840856916175502178,-0.00000011568619799600,1.99840856916175169111,0.59624195547795644234,-1.35044258839239805781,-0.00013796886217504634,-1.24420805193350902940,0.00000000000000000000,-0.00000062779973171089,-0.00063944201429980510,-0.00035116728409096163,0.00035179507838307224,0.00000062779429211276,0.00000000000543959810,-0.00063956434217505187,0.00004704022810007239,0.00068660457027518976,0.00030359402137870774,0.00063828117995589663,0.00000116083434391279,-0.00095300221790591260,-0.99840753085998246164,-0.00000002490781329550,-0.00159246914001944721,-0.00047512652254176873,0.00107610144488475847,0.00000010988386486871,0.00099146930986262669,0.00000000000000000000,0.00018041772492119511,-0.00063918241935313617,0.10091881098736142641,-0.10109922714904537311,-0.00018041616168395060,-0.00000000156323723109,0.18402032978806251440,-0.01359834639017785951,-0.19761867617824027676,-0.08748682772877110214,0.00065323701268678942,-0.00001405459333366375,-0.00095300229837294440,-1.99840769959612951645,0.99999988431385233856,1.99840769959612596374,0.59624169603575971621,-0.30949833267167170536,-0.00003162014601731565,-0.28515117864636235767,0.00000000000000000000,-0.00018104552465290601,-0.00000025959494666893,-0.10126997827145238495,0.10145102222742843900,0.00018104395597606337,0.00000000156867682920,-0.18465989413023756183,0.01364538661827793126,0.19830528074851547227,0.08779042175014981075,-0.00001495583273089269,0.00001521542767757654,0.00000000008046703181,0.00000016873614701665,0.00000009077833436207,-1.00000016873614550050,-0.59671682255830149622,0.31057443411655644150,0.00003173002988218436,0.28614264795622501580,0.00000000000000000000,0.00060680557769490068,0.00000086998035517506,0.33942395309671824499,-0.34003075341672001075,-0.00060680032000151444,-0.00000000525769334195,0.61891976589657560215,-0.04573488754088983477,-0.66465465343746532589,-0.29424487398035498176,0.00005012717281356467,-0.00005099715316878808,-0.00000000041467916683,-0.00000086956562566975,-0.00000000000005033843,0.00000086956562566975,1.00000025944219661511,-1.04094425572072646347,-0.00010634871615773068,-0.95905687328714650519,0.00000000000000000000,0.00060680557769490068,0.00000086998035517506,0.33942395309671824499,-0.34003075341672001075,-0.00060680032000151444,-0.00000000525769334195,0.61891976589657560215,-0.04573488754088983477,-0.66465465343746532589,-0.29424487398035498176,0.00005012717281356467,-0.00005099715316878808,-0.00000000041467916683,-0.00000086956562566975,-0.00000000000005033843,0.00000086956562566975,0.00000025944219668915,-0.04094425572072646347,-0.00010634871615773068,-0.95905687328714650519,0.00000000000000000000,0.00123951631112105142,0.00000177710106866645,0.69333826469885551091,-0.69457777027013367643,-0.00123950557127792678,-0.00000001073984303338,1.26426185470851604187,-0.09342224458378808882,-1.35768409929230404742,-0.60105136499880429390,0.00010239432631589547,-0.00010417142738466065,-0.00000000084706141482,-0.00000177625390442567,-0.00000000000010282585,0.00000177625390442567,0.00000052996024824111,-0.04094543292710910859,0.99978276243134578394,0.04094312671285362665,0.00000000000000000000,-0.00063271073342615084,-0.00000090712071349139,-0.35391431160213726592,
                0.35454701685341366568,0.00063270525127641245,0.00000000548214969143,-0.64534208881194043972,0.04768735704289825406,0.69302944585483872153,0.30680649101844931215,-0.00005226715350233079,0.00005317427421587257,0.00000000043238224800,0.00000090668827875592,0.00000000000005248742,-0.00000090668827875592,-0.00000027051805155196,-0.99999882279361740345,0.00011088885249653945,-0.00000000000000022204;
    }

    return S.transpose();

}



float GainStageSample(const float inputSample, const MyMat_G& S, Gain_Data& G_d)
{

    //---- Capacitors Initialization ----//

    //already done in G_d!

    //---- Diode Initialization ----//


    //max and min value initialization
//    float M = inputBuffer[0];
//    float m = 5;
    //input btw -1:1
    //float M = 4.42099;
    //float m = 3.97849;
    //input btw -0.5:0.5

    //computing output
    //float M = 4.33119;
    //float m = 4.06823;
    G_d.a[0] = inputSample; // Vs + Rs //----------------------------- [-1:1]
    G_d.a[2] = G_d.b[2]; // C3
    G_d.a[3] = 0; // Rb +
    G_d.a[4] = 0; // Rb -
    G_d.a[6] = -4.5; // Rg
    G_d.a[9] = 0; // R16
    G_d.a[10] = 0; // R19
    G_d.a[11] = 0; // R7
    G_d.a[12] = G_d.b[12]; // C16
    G_d.a[14] = 0; // Ra +
    G_d.a[15] = -4.5; // Rg
    G_d.a[19] = G_d.b[19]; // C10

    //--------- FORWARD SCAN --------------//

    //---- Series Junction ----//

    // S1

    G_d.a_S1[2] = 0; // R15
    G_d.a_S1[1] = G_d.b_S1[1]; // C11
    // waves reflected from first layer of adaptor
    G_d.b_S1[0] = G_d.S_S1_1 * G_d.a_S1;


    // S2

    G_d.a_S2[2] = 0; // R13
    G_d.a_S2[1] = G_d.b_S2[1]; // C9
    // waves reflected from first layer of adaptor
    G_d.b_S2[0] = G_d.S_S2_1 * G_d.a_S2;

    // S3

    G_d.a_S3[2] = 0; // R10
    G_d.a_S3[1] = 0; // Ra_neg
    // waves reflected from first layer of adaptor
    G_d.b_S3[0] = G_d.S_S3_1 * G_d.a_S3;

    //---- Series Attached to Parallel Junction ----//

    // S_P2

    G_d.a_S_P2[2] = 0; // R9
    G_d.a_S_P2[1] = G_d.b_S_P2[1]; // C6
    // waves reflected from first layer of adaptor
    G_d.b_S_P2[0] = G_d.S_S_P2_1 * G_d.a_S_P2;

    // S_P5

    G_d.a_S_P5[2] = 0; // R18
    G_d.a_S_P5[1] = G_d.b_S_P5[1]; // C12
    // waves reflected from first layer of adaptor
    G_d.b_S_P5[0] = G_d.S_S_P5_1 * G_d.a_S_P5;

    //---- Parrallel Attached to Series Junction ----//

    // P5

    G_d.a_P5[1] = 0; // R17
    G_d.a_P5[2] = G_d.b_S_P5[0]; // wave refl.by SP5 port 1
    G_d.b_P5[0] = G_d.S_P5_1 * G_d.a_P5;

    // P2

    G_d.a_P2[1] = 0; // R8
    G_d.a_P2[2] = G_d.b_S_P2[0]; // wave refl.by SP2 port 1
    G_d.b_P2[0] = G_d.S_P2_1 * G_d.a_P2;

    //--------- Parallel adaptors -------------//

    // P1

    G_d.a_P1[1] = G_d.b_P1[1]; // C4
    G_d.a_P1[2] = 0; // R5
    G_d.b_P1[0] = G_d.S_P1_1 * G_d.a_P1;

    // P3

    G_d.a_P3[1] = G_d.b_P3[1]; // C7
    G_d.a_P3[2] = 0;// R11
    G_d.b_P3[0] = G_d.S_P3_1 * G_d.a_P3;

    // P4

    G_d.a_P4[1] = G_d.b_P4[1]; // C8
    G_d.a_P4[2] = 0; // R12
    G_d.b_P4[0] = G_d.S_P4_1 * G_d.a_P4;

    // P6

    G_d.a_P6[1] = G_d.b_P6[1]; // C5
    G_d.a_P6[2] = 0; // R6
    G_d.b_P6[0] = G_d.S_P6_1 * G_d.a_P6;

    //------------ Series junction S3 + P3 -----------//

    // S3P3

    G_d.a_S3P3[2] = G_d.b_S3[0]; // S3 = Ra_neg + R10
    G_d.a_S3P3[1] = G_d.b_P3[0]; // P3 = R11//C7
    // waves reflected from first layer of adaptor
    G_d.b_S3P3[0] = G_d.S_S3P3_1 * G_d.a_S3P3;


    // waves reflected from series / parallel adaptors, incident toward S

    G_d.a[1] = G_d.b_P1[0];
    G_d.a[5] = G_d.b_P2[0];
    G_d.a[7] = G_d.b_S1[0];
    G_d.a[8] = G_d.b_P5[0];
    G_d.a[13] = G_d.b_P6[0];
    G_d.a[16] = G_d.b_S3P3[0];
    G_d.a[17] = G_d.b_P4[0];
    G_d.a[18] = G_d.b_S2[0];

    // Scattering stage

    G_d.b = S * G_d.a;
    G_d.a[20] = G_d.diode.Solve(G_d.b[20], G_d.z21);

    //--------- BACKWARD SCAN --------------//

    // Series S3 + P3 = S3P3

    G_d.a_S3P3[0] = G_d.b[16]; // from S
    G_d.b_S3P3[1] = G_d.S_S3P3_2 * G_d.a_S3P3;
    G_d.b_S3P3[2] = G_d.S_S3P3_3 * G_d.a_S3P3;

    //----------- Series -------------//

    // S1

    G_d.a_S1[0] = G_d.b[7]; // from S
    G_d.b_S1[1] = G_d.S_S1_2 * G_d.a_S1;
    G_d.b_S1[2] = G_d.S_S1_3 * G_d.a_S1;

    // S2

    G_d.a_S2[0] = G_d.b[18]; // from S
    G_d.b_S2[1] = G_d.S_S2_2 * G_d.a_S2;
    G_d.b_S2[2] = G_d.S_S2_3 * G_d.a_S2;

    // S3

    G_d.a_S3[0] = G_d.b_S3P3[2]; // from S3P3
    G_d.b_S3[1] = G_d.S_S3_2 * G_d.a_S3;
    G_d.b_S3[2] = G_d.S_S3_3 * G_d.a_S3;

    //----------- Parallel -------------//

    // P1

    G_d.a_P1[0] = G_d.b[1]; // from S
    G_d.b_P1[1] = G_d.S_P1_2 * G_d.a_P1;
    G_d.b_P1[2] = G_d.S_P1_3 * G_d.a_P1;

    // P3

    G_d.a_P3[0] = G_d.b_S3P3[1]; // from S3P3
    G_d.b_P3[1] = G_d.S_P3_2 * G_d.a_P3;
    G_d.b_P3[2] = G_d.S_P3_3 * G_d.a_P3;

    // P4

    G_d.a_P4[0] = G_d.b[17]; // from S
    G_d.b_P4[1] = G_d.S_P4_2 * G_d.a_P4;
    G_d.b_P4[2] = G_d.S_P4_3 * G_d.a_P4;

    // P6

    G_d.a_P6[0] = G_d.b[13]; // from S
    G_d.b_P6[1] = G_d.S_P6_2 * G_d.a_P6;
    G_d.b_P6[2] = G_d.S_P6_3 * G_d.a_P6;

    //------ parallel attached to series -----//

    // P2

    G_d.a_P2[0] = G_d.b[5]; // from S
    G_d.b_P2[1] = G_d.S_P2_2 * G_d.a_P2;
    G_d.b_P2[2] = G_d.S_P2_3 * G_d.a_P2;

    // P5

    G_d.a_P5[0] = G_d.b[8]; // from S
    G_d.b_P5[1] = G_d.S_P5_2 * G_d.a_P5;
    G_d.b_P5[2] = G_d.S_P5_3 * G_d.a_P5;

    //------- series attached to parallel ------//

    // S_P2

    G_d.a_S_P2[0] = G_d.b_P2[2];
    // waves reflected from S_P52to linear, adapted 2 - port elements
    G_d.b_S_P2[1] = G_d.S_S_P2_2 * G_d.a_S_P2;
    G_d.b_S_P2[2] = G_d.S_S_P2_3 * G_d.a_S_P2;

    // S_P5

    // wave incident to S_P5 from P5
    G_d.a_S_P5[0] = G_d.b_P5[2];
    //waves reflected from S_P5 to linear, adapted 2 - port elements
    G_d.b_S_P5[1] = G_d.S_S_P5_2 * G_d.a_S_P5;
    G_d.b_S_P5[2] = G_d.S_S_P5_3 * G_d.a_S_P5;

    // Read Output

    double outputSample =  ((-(G_d.a[10] + G_d.b[10] + G_d.a[12] + G_d.b[12]) / 2));
    return outputSample; //(2*((outputSample - m)/(M-m)) -1);
}
